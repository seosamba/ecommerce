<?php
$title = $this->translate('Shipping configuration');
$this->headTitle($title);
$this->placeholder('headerContent')->set($title);

$this->headScript()->appendFile($this->websiteUrl.'plugins/shopping/web/js/libs/require.min.js', null, array('data-main' => $this->websiteUrl.'plugins/shopping/web/js/shipping.js'));

?>
<!--[if lte IE 7]><script type="text/javascript" src="<?php echo $this->websiteUrl;?>plugins/shopping/web/css/icon-ie.js"></script><![endif]-->
<link type="text/css" rel="stylesheet" media="screen" href="<?php echo $this->websiteUrl; ?>plugins/shopping/web/css/toaster-icon.css">
<style>
#shippers ul li {
	clear: both;
	width: 100%;
}
#shippers ul li > a {
	width: 80%;
	overflow: hidden;
	text-overflow: ellipsis;
}
#shippers .ui-tabs-panel {
	padding: 4px;
}
#shippers #pane-container > div {
	border: 1px solid #cacaca;
}
#shippers #pane-container header {
	color: gray;
	padding: 4px 20px;
	border-bottom: 1px solid #b5b5b5;
	font-variant: small-caps;
	font-size: 120%;
}
.textright {
	text-align: right;
}
.relative {
	position: relative;
}
#shippers .relative input {

}
.unit-over {
	color: #999;
	position: absolute;
	top: 5px;
	right: 3px;
}
ul.ui-tabs-nav span.unit-over {
	cursor: pointer;
}
ul.ui-tabs-nav span.unit-over:hover {
	text-decoration: underline;
}
ul.ui-tabs-nav li.enabled a, ul.ui-tabs-nav li.enabled span.icon-checkmark{
	color: #228b22;
}
ul.ui-tabs-nav li.disabled a,  ul.ui-tabs-nav li.disabled span.icon-minus{
	color: #cd5c5c;
}
#ajax_msg {
	position: absolute;
	top: 3px;
	left: 0;
	width: 100%;
	z-index: 5000;
	text-align: center;
	display: none;
}
#ajax_msg img {
	vertical-align: middle;
}
ul.ui-tabs-nav li.enabled span.icon-checkmark, ul.ui-tabs-nav li.disabled span.icon-minus{
	margin-left: 5px;
    float:left;
}

</style>

<div id="ajax_msg"><img src="<?php echo $this->websiteUrl; ?>/system/images/loading.gif" /></div>
<form id="general-config" class="container_12 clearfix" style="min-height: 0">
    <label class="mt5px grid_6 omega" for="config-checkoutShippingTocRequire">
	    <?php echo $this->formCheckbox(
	        'config['.Shopping::SHIPPING_TOC_STATUS.']',
	        null,
	        array('checked' => isset($this->shoppingConfig[Shopping::SHIPPING_TOC_STATUS]) ? $this->shoppingConfig[Shopping::SHIPPING_TOC_STATUS] : false)
	        ); ?>
		<?php echo $this->translate('Require Shipping TOC on checkout. Use label (HTML ok):'); ?>
    </label>
	<div class="grid_6 alpha">
		<?php
		echo $this->formText(
		'config['.Shopping::SHIPPING_TOC_LABEL.']',
		isset($this->shoppingConfig[Shopping::SHIPPING_TOC_LABEL]) ? $this->shoppingConfig[Shopping::SHIPPING_TOC_LABEL] : null,
		array('placeholder' => $this->translate('left empty to use autogenerated label'))
		);
		?>
	</div>
    <div class="clear"></div>
    <label class="mt5px grid_6 omega" for="config-checkoutShippingErrorMessage">
        <?php echo $this->translate('Error message at the checkout page'); ?>
    </label>
    <div class="grid_6 alpha">
        <?php
        echo $this->formText(
            'config['.Shopping::SHIPPING_ERROR_MESSAGE.']',
            isset($this->shoppingConfig[Shopping::SHIPPING_ERROR_MESSAGE]) ? $this->shoppingConfig[Shopping::SHIPPING_ERROR_MESSAGE] : null,
            array('placeholder' => $this->translate('Error message at the checkout page'))
        );
        ?>
    </div>
</form>
<div id="shipping-config" class="container_12 clearfix">
	<div id="shippers" class="mt10px mb10px clearfix">
		<ul class="grid_4 omega">
            <li><a href="#markup" data-plugin="markup"><?php echo $this->translate('Markup');?></a></li>
			<li><a href="#pickup" data-plugin="pickup"><?php echo $this->translate('Pickup');?></a></li>
			<li><a href="#freeshipping" data-plugin="freeshipping"><?php echo $this->translate('Free shipping');?></a></li>
		<?php foreach($this->shippingPlugins as $plugin):?>
			<li><a data-plugin="<?php echo $plugin->getName();?>" href="<?php echo $this->url(array('run' => 'config', 'name' => strtolower($plugin->getName())), 'pluginroute');?>"><?php echo $plugin->getName();?></a></li>
		<?php endforeach; ?>
		</ul>
		<div id="pane-container" class="grid_8 alpha omega relative" style="padding: .1em .2em 0;">

            <div id="markup">
                <header><?php echo $this->translate('Shipping markup configuration');?></header>
                <?php $this->markupForm->setAction($this->url(array('run' => 'bundledshipper')));?>
                <form class="clearfix" action="<?php echo $this->markupForm->getAction();?>" method="post" enctype="application/x-www-form-urlencoded">
					<?php echo $this->markupForm->getElement('shipper')->renderViewHelper(); ?>
                    <label class="grid_3 mt5px textright" for="cartamount"><?php echo $this->markupForm->getElement('price')->getLabel();?></label>
					<div class="grid_2 relative">
                        <?php echo $this->markupForm->getElement('modifierSign')->renderViewHelper();?>
                    </div>
                    <div class="grid_2 relative">
						<?php echo $this->markupForm->getElement('price')->renderViewHelper();?>
						<label class="unit-over"><?php //echo $this->config['currency'];?></label>
					</div>
                    <div class="grid_2 relative">
                        <?php echo $this->markupForm->getElement('modifierType')->renderViewHelper();?>
                    </div>
                 </form>
            </div>
			<div id="pickup">
				<label style="display: block;margin: 10px; text-align: justify"><?php echo $this->translate('When this option is checked user will be given the option to pick their stuff up at your store location.'); ?></label>
			</div>
			<div id="freeshipping">
				<header><?php echo $this->translate('Free shipping');?></header>
				<?php $this->freeForm->setAction($this->url(array('run' => 'bundledshipper')));?>
				<form class="clearfix" action="<?php echo $this->freeForm->getAction();?>" method="post" enctype="application/x-www-form-urlencoded">
					<?php echo $this->freeForm->getElement('shipper')->renderViewHelper(); ?>
					<label class="grid_3 mt5px textright" for="cartamount"><?php echo $this->freeForm->getElement('cartamount')->getLabel();?></label>
					<div class="grid_3 relative">
						<?php echo $this->freeForm->getElement('cartamount')->renderViewHelper();?>
						<label class="unit-over"><?php echo $this->config['currency'];?></label>
					</div>
					<label class="grid_2 mt5px textcentered"><?php echo $this->freeForm->getElement('destination')->getLabel();?></label>
					<div class="grid_3">
						<?php echo $this->freeForm->getElement('destination')->renderViewHelper();?>
					</div>
                </form>
			</div>
		</div>
		<div class="grid_12 mt10px">
			<?php echo $this->formSubmit('submit', 'Save');?>
		</div>
	</div>
</div>

<script>
$(function(){
	$('form#general-config :input').on('change', function(){
		$.post($('#website_url').val() + 'plugin/shopping/run/setConfig', $(this).closest('form').serialize()) ;
	});

	$('#shippers').tabs({
		idPrefix: 'shipper-tab',
		panelTemplate: '<div class="clearfix"></div>',
		create: function(event, ui){
            $(this).find('ul.ui-tabs-nav, ul.ui-tabs-nav > li').removeClass('ui-corner-top ui-widget-header')
				.end().find('.ui-tabs-panel').removeClass('ui-corner-bottom');
		}
	});

	$(document).ajaxStart(function(){
		$('#ajax_msg').fadeIn();
	}).ajaxStop(function(){
		$('#ajax_msg').fadeOut();
	});
});
</script>