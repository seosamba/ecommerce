define(["backbone","../collections/orders","./order","text!../templates/paginator.html","text!../templates/export_dialog.html","text!../templates/tracking_code.html","text!../templates/refund_dialog.html","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln"],function(k,l,m,n,p,q,r,c){return k.View.extend({el:$("#store-orders"),events:{"click #extra-filters-switch":function(){$("#extra-filters",this.el).slideToggle()},"change input.filter":"applyFilter","change #orders-check-all":"checkAllOrders",
"click #orders-filter-apply-btn":"applyFilter","click td.paginator a.page":"navigate","click th.sortable":"sort","click button.change-status":"changeStatus","click td.shipping-service .setTracking":"changeTracking","click .sendInvoice":"sendInvoice","click #orders-filter-reset-btn":"resetFilter",'change select[name="order-mass-action"]':"massAction",'change input[name="check-order[]"]':"toggleOrder","change #filter-order-type":"toggleRecurring"},templates:{paginator:_.template(n)},initialize:function(){this.orders=
new l;this.orders.ordersChecked=[];var a=this.getParams();if(!_.isEmpty(a)&&"undefined"!==typeof a.filter){console.log(a);var b=!1;"undefined"!==typeof a.filter_from_date&&($("#orders-filter-fromdate").val(a.filter_from_date),b=!0);"undefined"!==typeof a.filter_to_date&&($("#orders-filter-todate").val(a.filter_to_date),b=!0);"undefined"!==typeof a.filter_status&&($("#filter-status").val(a.filter_status.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_by_coupon_code&&($("#filter-by-coupon-code").val(a.filter_by_coupon_code),
b=!0);"undefined"!==typeof a.filter_from_amount&&($("input[name=filter-from-amount]","#store-orders form.filters").val(a.filter_from_amount),b=!0);"undefined"!==typeof a.filter_from_amount&&($("input[name=filter-to-amount]","#store-orders form.filters").val(a.filter_from_to),b=!0);"undefined"!==typeof a.filter_order_type&&($("#filter-order-type").val(a.filter_order_type.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_country&&($("#filter-country").val(a.filter_country.split(",")).trigger("chosen:updated"),
b=!0);"undefined"!==typeof a.filter_state&&($("#filter-state").val(a.filter_state.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_carrier&&($("#filter-carrier").val(a.filter_carrier.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.exclude_quotes&&"1"===a.exclude_quotes&&($("#exclude-quotes-from-search").prop("checked",!0),b=!0);"undefined"!==typeof a.is_gift&&"1"===a.is_gift&&($("#is-a-gift").prop("checked",!0),b=!0);"undefined"!==typeof a.filter_by_order_id&&
$("input[name=search]").val(a.filter_by_order_id);"undefined"!==typeof a.filter_product_key&&$("input[name=filter-product-key]").val(a.filter_product_key);"undefined"!==typeof a.filter_by_user_name&&$("input[name=user-name]").val(a.filter_by_user_name);!0===b&&$("#extra-filters").slideToggle()}this.orders.server_api=_.extend(this.orders.server_api,{id:function(){return $("input[name=search]").val()},filter:function(){return{"product-key":$("input[name=filter-product-key]","#store-orders form.filters").val(),
status:$("#filter-status","#store-orders form.filters").val(),country:$("select[name=filter-country]","#store-orders form.filters").val(),state:$("select[name=filter-state]","#store-orders form.filters").val(),carrier:$("select[name=filter-carrier]","#store-orders form.filters").val(),"date-from":$("input[name=filter-from-date]","#store-orders form.filters").val(),"date-to":$("input[name=filter-to-date]","#store-orders form.filters").val(),"amount-from":$("input[name=filter-from-amount]","#store-orders form.filters").val(),
"amount-to":$("input[name=filter-to-amount]","#store-orders form.filters").val(),user:$("input[name=user-name]","#store-orders form.filters").val(),"filter-order-type":$("select[name=filter-order-type]","#store-orders form.filters").val(),"filter-recurring-order-type":$("select[name=filter-recurring-order-type]","#store-orders form.filters").val(),"filter-by-coupon":$("input[name=filter-by-coupon-code]","#store-orders form.filters").val(),"filter-exclude-quotes":function(){return $("#exclude-quotes-from-search").is(":checked")?
"1":"0"},is_gift:function(){return $("#is-a-gift").is(":checked")?"1":"0"}}}});this.orders.on("reset",this.renderOrders,this);this.orders.pager()},massAction:function(a){var b=$(a.currentTarget).val()+"Action";if(_.isFunction(this[b])){var d=this.orders;d.length&&this[b].call(this,d)}$(a.currentTarget).val(0)},checkAllOrders:function(a){var b=this.orders.ordersChecked,d=[];a.target.checked?this.orders.each(function(a){b=_.union(b,[a.id]);a.set({checked:!0})}):(this.orders.each(function(a){d=_.union(d,
[a.id]);a.set({checked:!1})}),b=_.difference(b,d));this.orders.ordersChecked=b;"function"===typeof _checkboxRadio&&_checkboxRadio()},toggleOrder:function(a){var b=$(a.target).val();a.target.checked?this.orders.ordersChecked=_.union(this.orders.ordersChecked,[b]):(a=_.filter(this.orders.ordersChecked,function(a){return a!==b}),this.orders.ordersChecked=a);"function"===typeof _checkboxRadio&&_checkboxRadio()},exportOrdersAction:function(){var a=this.orders.ordersChecked.join(","),b=this.orders.server_api.filter();
_.isUndefined(c.Export);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getOrderExportConfig/",type:"GET",dataType:"json"}).done(function(d){d=_.template(p,{ordersIds:a,filters:$.param(b),i18n:c,defaultConfig:d.responseText.defaultConfig,exportConfig:d.responseText.export_config});$(d).dialog({dialogClass:"seotoaster",width:"75%",height:"750",resizable:!1});return!1})},resetFilters:function(){this.$("form.filters > :input").val("")},render:function(){},renderOrder:function(a){a.set({useInvoice:$("#invoiceEnable").val()});
a.set({i18n:c});a=new m({model:a});this.$("#orders-list").append(a.render().el)},renderOrders:function(){this.$("#orders-list").empty();this.orders.each(this.renderOrder.bind(this));this.orders.info().i18n=c;this.$("td.paginator").html(this.templates.paginator(this.orders.information))},applyFilter:function(a){"undefined"!==typeof a&&a.preventDefault();this.orders.ordersChecked=[];this.orders.currentPage=0;this.orders.pager()},resetFilter:function(a){a.preventDefault();$(a.currentTarget).closest("form").find("input:text").val("").end().find("select.filter").val("0").trigger("chosen:updated");
$("#exclude-quotes-from-search").prop("checked",!1);$("#is-a-gift").prop("checked",!1);this.applyFilter()},navigate:function(a){a.preventDefault();a=$(a.currentTarget).data("page");if($.isNumeric(a))this.orders.goTo(a);else switch(a){case "first":this.orders.goTo(this.orders.firstPage);break;case "last":this.orders.goTo(this.orders.totalPages);break;case "prev":this.orders.requestPreviousPage();break;case "next":this.orders.requestNextPage()}},sort:function(a){a=$(a.currentTarget);var b=a.data("sortkey");
a.siblings(".sortable").removeClass("sortUp").removeClass("sortDown");b&&(a.hasClass("sortUp")||a.hasClass("sortDown")?(a.hasClass("sortUp")&&(b+=" DESC"),a.hasClass("sortDown")&&(b+=" ASC"),a.toggleClass("sortUp").toggleClass("sortDown")):(a.addClass("sortUp"),b+=" ASC"),this.orders.server_api.order=b,this.orders.pager())},changeStatus:function(a){var b=$(a.currentTarget),d=parseInt(b.closest("div").data("order-id")),e=_.isUndefined(c["Are you sure you want to change status for this order?"])?"Are you sure you want to change status for this order?":
c["Are you sure you want to change status for this order?"],f=b.data("status"),g=this.orders.get(d);if("refunded"===f){e=_.isUndefined(c["Are you sure you want to refund this payment?"])?"Are you sure you want to refund this payment?":c["Are you sure you want to refund this payment?"];a=_.isUndefined(c.Refund)?"Refund":c.Refund;var h={},t=_.template(r,{i18n:c,orderId:d,gateway:g.get("gateway"),total:g.get("total")});h[a]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(e,function(a){a&&
$.ajax({url:$("#website_url").val()+"plugin/shopping/run/refundPayment/orderId/",type:"POST",dataType:"json",data:{orderId:$("#refund-order-id").val(),refundAmount:$(".partial-refund-amount").val(),refundInfo:$(".refund-info").val(),secureToken:$(".orders-secure-token").val(),paymentGateway:g.get("gateway"),refundUsingPaymentGateway:$("input.use-refund-payment-gateway").is(":checked")?1:0,refundTax:$(".refund-tax").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText.message,
!1,5E3),g.set("status",f),g.set("total",a.responseText.total),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(c.Yes)?"Yes":c.Yes,cancel:_.isUndefined(c.No)?"No":c.No})};$(t).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:h,resizable:!1,open:function(a,b){},close:function(a,b){$(this).dialog("destroy")}})}else smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order?id="+d,data:{status:f},type:"POST",dataType:"json",beforeSend:function(){b.closest("td").html('<img src="'+
$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){showMessage(_.isUndefined(c.Saved)?"Saved":c.Saved,a.hasOwnProperty("error")&&a.error);!a.error&&a.hasOwnProperty("responseText")&&g.set("status",a.responseText.status)}})},{ok:_.isUndefined(c.Yes)?"Yes":c.Yes,cancel:_.isUndefined(c.No)?"No":c.No})},changeTracking:function(a){var b=$(a.currentTarget),d=parseInt(b.closest("tr").find("td.order-id").text()),e=this.orders.get(d);
$.ajax({url:$("#website_url").val()+"plugin/shopping/run/fetchShippingUrlNames/orderId/"+d,type:"GET",dataType:"json"}).done(function(a){a=_.template(q,{data:a.responseText.data,defaultSelection:a.responseText.defaultSelection,trackingId:a.responseText.trackingId,trackingName:a.responseText.trackingName,orderId:d,i18n:c});$(a).dialog({width:600,dialogClass:"seotoaster",resizable:!1,open:function(a,f){$(".save-data").on("click",function(a){a.preventDefault();a=$("#marketing-services").val();var f=
$("#shippingTrackingId").val();a={trackingUrlId:a,shippingTrackingId:f,id:d};$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order",data:a,type:"POST",dataType:"json",beforeSend:function(){b.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&!a.error&&showMessage(_.isUndefined(c.Saved)?"Saved":c.Saved);a.hasOwnProperty("responseText")&&e.set({status:a.responseText.status,
shipping_tracking_id:a.responseText.shippingTrackingId})}})})},close:function(a,b){$(this).dialog("close").remove()}})})},sendInvoice:function(a){a=$(a.currentTarget);var b=parseInt(a.closest("tr").find("td.order-id").text()),d=a.closest("td"),e=d.html();$.ajax({url:$("#website_url").val()+"plugin/invoicetopdf/run/sendInvoiceToUser/",data:{cartId:b,dwn:0},type:"POST",dataType:"json",beforeSend:function(){d.html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},
success:function(a){a.hasOwnProperty("error")&&(a.error?showMessage(a.responseText,!1,5E3):showMessage(_.isUndefined(c["Invoice has been sent"])?"Invoice has been sent":c["Invoice has been sent"]));d.html(e)}})},toggleRecurring:function(a){"recurring_id"===$(a.currentTarget).val()?$(".recurring-filters").removeClass("hidden"):$(".recurring-filters").addClass("hidden")},getParams:function(){var a={},b=[];location.search.substr(1).split("&").forEach(function(c){b=c.split("=");a[decodeURIComponent(b[0])]=
decodeURIComponent(b[1])});return a}})});
