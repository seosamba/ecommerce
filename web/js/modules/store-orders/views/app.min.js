define(["backbone","../collections/orders","./order","text!../templates/paginator.html","text!../templates/export_dialog.html","text!../templates/tracking_code.html","text!../templates/refund_dialog.html","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln"],function(k,l,m,n,p,q,r,b){return k.View.extend({el:$("#store-orders"),events:{"click #extra-filters-switch":function(){$("#extra-filters",this.el).slideToggle()},"change input.filter":"applyFilter","change #orders-check-all":"checkAllOrders",
"click #orders-filter-apply-btn":"applyFilter","click td.paginator a.page":"navigate","click th.sortable":"sort","click button.change-status":"changeStatus","click td.shipping-service .setTracking":"changeTrackigCode","click .sendInvoice":"sendInvoice","click #orders-filter-reset-btn":"resetFilter",'change select[name="order-mass-action"]':"massAction",'change input[name="check-order[]"]':"toggleOrder","change #filter-order-type":"toggleRecurring"},templates:{paginator:_.template(n)},initialize:function(){this.orders=
new l;this.orders.ordersChecked=[];this.orders.server_api=_.extend(this.orders.server_api,{id:function(){return $("input[name=search]").val()},filter:function(){return{"product-key":$("input[name=filter-product-key]","#store-orders form.filters").val(),status:$("#filter-status","#store-orders form.filters").val(),country:$("select[name=filter-country]","#store-orders form.filters").val(),state:$("select[name=filter-state]","#store-orders form.filters").val(),carrier:$("select[name=filter-carrier]",
"#store-orders form.filters").val(),"date-from":$("input[name=filter-from-date]","#store-orders form.filters").val(),"date-to":$("input[name=filter-to-date]","#store-orders form.filters").val(),"amount-from":$("input[name=filter-from-amount]","#store-orders form.filters").val(),"amount-to":$("input[name=filter-to-amount]","#store-orders form.filters").val(),user:$("input[name=user-name]","#store-orders form.filters").val(),"filter-order-type":$("select[name=filter-order-type]","#store-orders form.filters").val(),
"filter-recurring-order-type":$("select[name=filter-recurring-order-type]","#store-orders form.filters").val(),"filter-by-coupon":$("input[name=filter-by-coupon-code]","#store-orders form.filters").val()}}});this.orders.on("reset",this.renderOrders,this);this.orders.pager()},massAction:function(a){var b=$(a.currentTarget).val()+"Action";if(_.isFunction(this[b])){var c=this.orders;c.length&&this[b].call(this,c)}$(a.currentTarget).val(0)},checkAllOrders:function(a){var b=this.orders.ordersChecked,c=
[];a.target.checked?this.orders.each(function(a){b=_.union(b,[a.id]);a.set({checked:!0})}):(this.orders.each(function(a){c=_.union(c,[a.id]);a.set({checked:!1})}),b=_.difference(b,c));this.orders.ordersChecked=b},toggleOrder:function(a){var b=$(a.target).val();a.target.checked?this.orders.ordersChecked=_.union(this.orders.ordersChecked,[b]):(a=_.filter(this.orders.ordersChecked,function(a){return a!==b}),this.orders.ordersChecked=a)},exportOrdersAction:function(){var a=this.orders.ordersChecked.join(","),
d=this.orders.server_api.filter();_.isUndefined(b.Export);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getOrderExportConfig/",type:"GET",dataType:"json"}).done(function(c){c=_.template(p,{ordersIds:a,filters:$.param(d),i18n:b,defaultConfig:c.responseText.defaultConfig,exportConfig:c.responseText.export_config});$(c).dialog({dialogClass:"seotoaster",width:"75%",height:"750",resizable:!1});return!1})},resetFilters:function(){this.$("form.filters > :input").val("")},render:function(){},renderOrder:function(a){a.set({useInvoice:$("#invoiceEnable").val()});
a.set({i18n:b});a=new m({model:a});this.$("#orders-list").append(a.render().el)},renderOrders:function(){this.$("#orders-list").empty();this.orders.each(this.renderOrder.bind(this));this.orders.info().i18n=b;this.$("td.paginator").html(this.templates.paginator(this.orders.information))},applyFilter:function(a){"undefined"!==typeof a&&a.preventDefault();this.orders.ordersChecked=[];this.orders.currentPage=0;this.orders.pager()},resetFilter:function(a){a.preventDefault();$(a.currentTarget).closest("form").find("input:text").val("").end().find("select.filter").val("0").trigger("chosen:updated");
this.applyFilter()},navigate:function(a){a.preventDefault();a=$(a.currentTarget).data("page");if($.isNumeric(a))this.orders.goTo(a);else switch(a){case "first":this.orders.goTo(this.orders.firstPage);break;case "last":this.orders.goTo(this.orders.totalPages);break;case "prev":this.orders.requestPreviousPage();break;case "next":this.orders.requestNextPage()}},sort:function(a){a=$(a.currentTarget);var b=a.data("sortkey");a.siblings(".sortable").removeClass("sortUp").removeClass("sortDown");b&&(a.hasClass("sortUp")||
a.hasClass("sortDown")?(a.hasClass("sortUp")&&(b+=" DESC"),a.hasClass("sortDown")&&(b+=" ASC"),a.toggleClass("sortUp").toggleClass("sortDown")):(a.addClass("sortUp"),b+=" ASC"),this.orders.server_api.order=b,this.orders.pager())},changeStatus:function(a){var d=$(a.currentTarget),c=parseInt(d.closest("div").data("order-id")),e=_.isUndefined(b["Are you sure you want to change status for this order?"])?"Are you sure you want to change status for this order?":b["Are you sure you want to change status for this order?"],
f=d.data("status"),g=this.orders.get(c);if("refunded"===f){e=_.isUndefined(b["Are you sure you want to refund this payment?"])?"Are you sure you want to refund this payment?":b["Are you sure you want to refund this payment?"];a=_.isUndefined(b.Refund)?"Refund":b.Refund;var h={},t=_.template(r,{i18n:b,orderId:c,gateway:g.get("gateway"),total:g.get("total")});h[a]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/refundPayment/orderId/",
type:"POST",dataType:"json",data:{orderId:$("#refund-order-id").val(),refundAmount:$(".partial-refund-amount").val(),refundInfo:$(".refund-info").val(),secureToken:$(".orders-secure-token").val(),paymentGateway:g.get("gateway"),refundUsingPaymentGateway:$("input.use-refund-payment-gateway").is(":checked")?1:0,refundTax:$(".refund-tax").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText.message,!1,5E3),g.set("status",f),g.set("total",a.responseText.total),
$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};$(t).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:h,resizable:!1,open:function(a,b){},close:function(a,b){$(this).dialog("destroy")}})}else smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order?id="+c,data:{status:f},type:"POST",dataType:"json",beforeSend:function(){d.closest("td").html('<img src="'+$("#website_url").val()+
'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved,a.hasOwnProperty("error")&&a.error);!a.error&&a.hasOwnProperty("responseText")&&g.set("status",a.responseText.status)}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})},changeTrackigCode:function(a){var d=$(a.currentTarget),c=parseInt(d.closest("tr").find("td.order-id").text()),e=this.orders.get(c);$.ajax({url:$("#website_url").val()+
"plugin/shopping/run/fetchNames",type:"GET",dataType:"json"}).done(function(a){console.log(a);a=_.template(q,{data:a.responseText.data,defaultSelection:a.responseText.defaultSelection,orderId:c,i18n:b});$(a).dialog({width:600,dialogClass:"seotoaster",resizable:!1,open:function(a,f){$(".setTracking").on("click",function(){});$(".save-data").on("click",function(){var a=$("#marketing-services").val(),f=$("#shippingTrackingId").val(),a={name:a,shippingTrackingId:f};$.ajax({url:$("#website_url").val()+
"plugin/shopping/run/order?id="+c,data:a,type:"POST",dataType:"json",beforeSend:function(){d.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&!a.error&&showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved);a.hasOwnProperty("responseText")&&e.set({status:a.responseText.status,shipping_tracking_id:a.responseText.shippingTrackingId})}})})},close:function(a,b){$(this).dialog("close").remove()}})})},
changeTracking:function(a){var d=$(a.currentTarget),c=parseInt(d.closest("tr").find("td.order-id").text()),e=this.orders.get(c);if(!e)return!1;smoke.prompt(_.isUndefined(b["Insert tracking code for this order"])?"Insert tracking code for this order":b["Insert tracking code for this order"],function(a){if(!1===a)return a;a=$.trim(a);e.get("shipping_tracking_id")!==a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order?id="+c,data:{shippingTrackingId:a},type:"POST",dataType:"json",beforeSend:function(){d.closest("td").html('<img src="'+
$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&!a.error&&showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved);a.hasOwnProperty("responseText")&&e.set({status:a.responseText.status,shipping_tracking_id:a.responseText.shippingTrackingId})}})},{value:e.get("shipping_tracking_id"),ok:_.isUndefined(b.OK)?"OK":b.OK,cancel:_.isUndefined(b.Cancel)?"Cancel":b.Cancel})},sendInvoice:function(a){a=$(a.currentTarget);
var d=parseInt(a.closest("tr").find("td.order-id").text()),c=a.closest("td"),e=c.html();$.ajax({url:$("#website_url").val()+"plugin/invoicetopdf/run/sendInvoiceToUser/",data:{cartId:d,dwn:0},type:"POST",dataType:"json",beforeSend:function(){c.html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&(a.error?showMessage(a.responseText,!1,5E3):showMessage(_.isUndefined(b["Invoice has been sent"])?
"Invoice has been sent":b["Invoice has been sent"]));c.html(e)}})},toggleRecurring:function(a){"recurring_id"===$(a.currentTarget).val()?$(".recurring-filters").removeClass("hidden"):$(".recurring-filters").addClass("hidden")}})});
