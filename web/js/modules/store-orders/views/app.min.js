define(["backbone","../collections/orders","./order","text!../templates/paginator.html","text!../templates/export_dialog.html","text!../templates/tracking_code.html","text!../templates/refund_dialog.html","text!../templates/shipping_labels_dates_dialog.html","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln","moment","accounting"],function(m,n,p,q,r,s,t,u,b,k,v){return m.View.extend({el:$("#store-orders"),events:{"click #extra-filters-switch":function(){$("#extra-filters",this.el).slideToggle()},
"change input.filter":"applyFilter","change #orders-check-all":"checkAllOrders","click #orders-filter-apply-btn":"applyFilter","click td.paginator a.page":"navigate","click th.sortable":"sort","click button.change-status":"changeStatus","click td.shipping-service .setTracking":"changeTracking","click .sendInvoice":"sendInvoice","click #orders-filter-reset-btn":"resetFilter",'change select[name="order-mass-action"]':"massAction",'change input[name="check-order[]"]':"toggleOrder","change #filter-order-type":"toggleRecurring",
"click .generate-shipping-order-label":"generateShippingLabel"},templates:{paginator:_.template(q)},initialize:function(){this.orders=new n;this.orders.ordersChecked=[];this.orders.server_api=_.extend(this.orders.server_api,{id:function(){return $("input[name=search]").val()},filter:function(){return{"product-key":$("input[name=filter-product-key]","#store-orders form.filters").val(),status:$("#filter-status","#store-orders form.filters").val(),country:$("select[name=filter-country]","#store-orders form.filters").val(),
state:$("select[name=filter-state]","#store-orders form.filters").val(),carrier:$("select[name=filter-carrier]","#store-orders form.filters").val(),"date-from":$("input[name=filter-from-date]","#store-orders form.filters").val(),"date-to":$("input[name=filter-to-date]","#store-orders form.filters").val(),"amount-from":$("input[name=filter-from-amount]","#store-orders form.filters").val(),"amount-to":$("input[name=filter-to-amount]","#store-orders form.filters").val(),user:$("input[name=user-name]",
"#store-orders form.filters").val(),"filter-order-type":$("select[name=filter-order-type]","#store-orders form.filters").val(),"filter-recurring-order-type":$("select[name=filter-recurring-order-type]","#store-orders form.filters").val(),"filter-by-coupon":$("input[name=filter-by-coupon-code]","#store-orders form.filters").val()}}});this.orders.on("reset",this.renderOrders,this);this.orders.pager()},massAction:function(a){var b=$(a.currentTarget).val()+"Action";if(_.isFunction(this[b])){var c=this.orders;
c.length&&this[b].call(this,c)}$(a.currentTarget).val(0)},generateShippingLabel:function(a){_.isUndefined(b["Do you want to specify shipment date?"]);var e=_.isUndefined(b["Do you want to create a label?"])?"Do you want to create a label?":b["Do you want to create a label?"],c=_.isUndefined(b["Do you want to use this date for the shipping label?"])?"Do you want to use this date for the shipping label?":b["Do you want to use this date for the shipping label?"],d=$(a.currentTarget).data("order-id"),
f=this,h=this.orders.get(d),l={},g=_.isUndefined(b["Create label"])?"Create label":b["Create label"],w=$(a.currentTarget).closest("tr");l[g]=function(){$(".ui-dialog").css("zIndex","101");var a=$("#shipment-availability-result-"+d).data("availability-date"),e=$("#shipment-availability-result-"+d).data("availability-time");console.log($("#shipment-availability-result-"+d).data("availability-date"));if(!$("#shipment-availability-result-"+d).data("availability-date"))return showMessage(_.isUndefined(b["Please specify shipment date"])?
"Please specify shipment date":b["Please specify shipment date"],!0,5E3),!1;if(!$("#shipment-availability-result-"+d).data("availability-time"))return showMessage(_.isUndefined(b["Please specify shipment time"])?"Please specify shipment time":b["Please specify shipment time"],!0,5E3),!1;smoke.confirm(c,function(b){b&&f.generateShippingLabelRequest(d,a,e,w)},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};smoke.confirm(e,function(a){if(a){a=JSON.parse(h.get("shipping_availability_days"));
var e=_.template(u,{orderId:d,i18n:b,shippingAvailabilityDays:a,accounting:v,moneyFormat:f.orders.moneyFormat}),c=[],g=[];_.each(a.availabilityDates,function(a,b){"undefined"===typeof c[k(b,"YYYY-MM-DD").format("MM")]?c[k(b,"YYYY-MM-DD").format("MM")]=[parseInt(k(b,"YYYY-MM-DD").format("D"))]:c[k(b,"YYYY-MM-DD").format("MM")].push(parseInt(k(b,"YYYY-MM-DD").format("D")));"undefined"===typeof g[b]?g[b]=[a]:g[b].push(a)});$(e).dialog({dialogClass:"seotoaster",width:"75%",height:"400",resizable:!1,buttons:l,
open:function(a,b){$("#availability-days-datepicker").datepicker({beforeShowDay:function(a){return"undefined"===typeof c[a.getMonth()+1]?[!1,""]:_.contains(c[a.getMonth()+1],parseInt(a.getDate()))?[!0,""]:[!1,""]},onSelect:function(){"undefined"!==typeof g[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))]&&($("#availability-shipment-time-"+d).empty(),$("#shipment-availability-summary-"+d).find(".shipment-availability-date-summary").empty().text($.datepicker.formatDate("dd M yy",$(this).datepicker("getDate"))),
$("#shipment-availability-summary-"+d).find(".shipment-availability-time-summary").empty().text(""),$("#shipment-availability-result-"+d).data("availability-date",$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))).data("availability-time",""),_.each(g[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))],function(a,b){_.each(a,function(a){$("#availability-shipment-time-"+d).append('<button class="availability-shipment-time btn">'+a+"</button>")})}))}});$("#availability-shipment-time-"+
d).on("click",".availability-shipment-time",function(a){a=$(a.currentTarget);a.closest("div").find(".availability-shipment-time").removeClass("current");a.addClass("current");$("#shipment-availability-summary-"+d).find(".shipment-availability-time-summary").empty().text(a.text());$("#shipment-availability-result-"+d).data("availability-time",a.text())})},close:function(a,b){$(this).dialog("destroy")}});checkboxRadioStyle();return!1}})},generateShippingLabelRequest:function(a,b,c,d){var f=this.orders.get(a);
$.ajax({url:$("#website_url").val()+"plugin/shopping/run/shippingLabel/",type:"POST",dataType:"json",data:{orderId:a,secureToken:$(".orders-secure-token").val(),availabilityDate:b,availabilityTime:c}}).done(function(a){"1"==a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText.message,!1,5E3),a.responseText.shipping_label_link&&(d.find(".shipping-label-link").removeClass("hidden").val(a.responseText.shipping_label_link),f.set({shipping_label_link:a.responseText.shipping_label_link})),
$(".ui-dialog-titlebar-close").trigger("click"))})},checkAllOrders:function(a){var b=this.orders.ordersChecked,c=[];a.target.checked?this.orders.each(function(a){b=_.union(b,[a.id]);a.set({checked:!0})}):(this.orders.each(function(a){c=_.union(c,[a.id]);a.set({checked:!1})}),b=_.difference(b,c));this.orders.ordersChecked=b;"function"===typeof _checkboxRadio&&_checkboxRadio()},toggleOrder:function(a){var b=$(a.target).val();a.target.checked?this.orders.ordersChecked=_.union(this.orders.ordersChecked,
[b]):(a=_.filter(this.orders.ordersChecked,function(a){return a!==b}),this.orders.ordersChecked=a);"function"===typeof _checkboxRadio&&_checkboxRadio()},exportOrdersAction:function(){var a=this.orders.ordersChecked.join(","),e=this.orders.server_api.filter();_.isUndefined(b.Export);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getOrderExportConfig/",type:"GET",dataType:"json"}).done(function(c){c=_.template(r,{ordersIds:a,filters:$.param(e),i18n:b,defaultConfig:c.responseText.defaultConfig,
exportConfig:c.responseText.export_config});$(c).dialog({dialogClass:"seotoaster",width:"75%",height:"750",resizable:!1});return!1})},resetFilters:function(){this.$("form.filters > :input").val("")},render:function(){},renderOrder:function(a){a.set({useInvoice:$("#invoiceEnable").val()});a.set({i18n:b});a=new p({model:a});this.$("#orders-list").append(a.render().el)},renderOrders:function(){this.$("#orders-list").empty();this.orders.each(this.renderOrder.bind(this));this.orders.info().i18n=b;this.$("td.paginator").html(this.templates.paginator(this.orders.information))},
applyFilter:function(a){"undefined"!==typeof a&&a.preventDefault();this.orders.ordersChecked=[];this.orders.currentPage=0;this.orders.pager()},resetFilter:function(a){a.preventDefault();$(a.currentTarget).closest("form").find("input:text").val("").end().find("select.filter").val("0").trigger("chosen:updated");this.applyFilter()},navigate:function(a){a.preventDefault();a=$(a.currentTarget).data("page");if($.isNumeric(a))this.orders.goTo(a);else switch(a){case "first":this.orders.goTo(this.orders.firstPage);
break;case "last":this.orders.goTo(this.orders.totalPages);break;case "prev":this.orders.requestPreviousPage();break;case "next":this.orders.requestNextPage()}},sort:function(a){a=$(a.currentTarget);var b=a.data("sortkey");a.siblings(".sortable").removeClass("sortUp").removeClass("sortDown");b&&(a.hasClass("sortUp")||a.hasClass("sortDown")?(a.hasClass("sortUp")&&(b+=" DESC"),a.hasClass("sortDown")&&(b+=" ASC"),a.toggleClass("sortUp").toggleClass("sortDown")):(a.addClass("sortUp"),b+=" ASC"),this.orders.server_api.order=
b,this.orders.pager())},changeStatus:function(a){var e=$(a.currentTarget),c=parseInt(e.closest("div").data("order-id")),d=_.isUndefined(b["Are you sure you want to change status for this order?"])?"Are you sure you want to change status for this order?":b["Are you sure you want to change status for this order?"],f=e.data("status"),h=this.orders.get(c);if("refunded"===f){d=_.isUndefined(b["Are you sure you want to refund this payment?"])?"Are you sure you want to refund this payment?":b["Are you sure you want to refund this payment?"];
a=_.isUndefined(b.Refund)?"Refund":b.Refund;var l={},g=_.template(t,{i18n:b,orderId:c,gateway:h.get("gateway"),total:h.get("total")});l[a]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(d,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/refundPayment/orderId/",type:"POST",dataType:"json",data:{orderId:$("#refund-order-id").val(),refundAmount:$(".partial-refund-amount").val(),refundInfo:$(".refund-info").val(),secureToken:$(".orders-secure-token").val(),paymentGateway:h.get("gateway"),
refundUsingPaymentGateway:$("input.use-refund-payment-gateway").is(":checked")?1:0,refundTax:$(".refund-tax").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText.message,!1,5E3),h.set("status",f),h.set("total",a.responseText.total),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};$(g).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:l,resizable:!1,open:function(a,
b){},close:function(a,b){$(this).dialog("destroy")}})}else smoke.confirm(d,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order?id="+c,data:{status:f},type:"POST",dataType:"json",beforeSend:function(){e.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved,a.hasOwnProperty("error")&&a.error);!a.error&&a.hasOwnProperty("responseText")&&
h.set("status",a.responseText.status)}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})},changeTracking:function(a){var e=$(a.currentTarget),c=parseInt(e.closest("tr").find("td.order-id").text()),d=this.orders.get(c);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/fetchShippingUrlNames",type:"GET",dataType:"json"}).done(function(a){a=_.template(s,{data:a.responseText.data,defaultSelection:a.responseText.defaultSelection,orderId:c,i18n:b});$(a).dialog({width:600,
dialogClass:"seotoaster",resizable:!1,open:function(a,f){$(".save-data").on("click",function(a){a.preventDefault();a=$("#marketing-services").val();var f=$("#shippingTrackingId").val();a={trackingUrlId:a,shippingTrackingId:f,id:c};$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order",data:a,type:"POST",dataType:"json",beforeSend:function(){e.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&
!a.error&&showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved);a.hasOwnProperty("responseText")&&d.set({status:a.responseText.status,shipping_tracking_id:a.responseText.shippingTrackingId})}})})},close:function(a,b){$(this).dialog("close").remove()}})})},sendInvoice:function(a){a=$(a.currentTarget);var e=parseInt(a.closest("tr").find("td.order-id").text()),c=a.closest("td"),d=c.html();$.ajax({url:$("#website_url").val()+"plugin/invoicetopdf/run/sendInvoiceToUser/",data:{cartId:e,dwn:0},type:"POST",
dataType:"json",beforeSend:function(){c.html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&(a.error?showMessage(a.responseText,!1,5E3):showMessage(_.isUndefined(b["Invoice has been sent"])?"Invoice has been sent":b["Invoice has been sent"]));c.html(d)}})},toggleRecurring:function(a){"recurring_id"===$(a.currentTarget).val()?$(".recurring-filters").removeClass("hidden"):$(".recurring-filters").addClass("hidden")}})});
