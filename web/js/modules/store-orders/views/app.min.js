define(["backbone","../collections/orders","./order","text!../templates/paginator.html","text!../templates/export_dialog.html","text!../templates/tracking_code.html","text!../templates/refund_dialog.html","text!../templates/shipping_labels_dates_dialog.html","text!../templates/refund_shipment_dialog.html","text!../templates/send_payment_request_dialog.html","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln","moment","accounting","tinyMCE"],function(r,t,u,v,w,x,y,z,A,B,b,l,q,m){return r.View.extend({el:$("#store-orders"),
events:{"click #extra-filters-switch":function(){$("#extra-filters",this.el).slideToggle()},"change input.filter":"applyFilter","change #orders-check-all":"checkAllOrders","click #orders-filter-apply-btn":"applyFilter","click td.paginator a.page":"navigate","click th.sortable":"sort","click button.change-status":"changeStatus","click td.shipping-service .setTracking":"changeTracking","click .sendInvoice":"sendInvoice","click #orders-filter-reset-btn":"resetFilter",'change select[name="order-mass-action"]':"massAction",
'change input[name="check-order[]"]':"toggleOrder","change #filter-order-type":"toggleRecurring","click .generate-shipping-order-label":"generateShippingLabel","click .refund-shipping-order-label":"refundShippingLabel"},templates:{paginator:_.template(v)},initialize:function(){this.orders=new t;this.orders.ordersChecked=[];var a=this.getParams();if(!_.isEmpty(a)&&"undefined"!==typeof a.filter){console.log(a);var b=!1;"undefined"!==typeof a.filter_from_date&&($("#orders-filter-fromdate").val(a.filter_from_date),
b=!0);"undefined"!==typeof a.filter_to_date&&($("#orders-filter-todate").val(a.filter_to_date),b=!0);"undefined"!==typeof a.filter_status&&($("#filter-status").val(a.filter_status.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_by_coupon_code&&($("#filter-by-coupon-code").val(a.filter_by_coupon_code),b=!0);"undefined"!==typeof a.filter_from_amount&&($("input[name=filter-from-amount]","#store-orders form.filters").val(a.filter_from_amount),b=!0);"undefined"!==typeof a.filter_from_amount&&
($("input[name=filter-to-amount]","#store-orders form.filters").val(a.filter_from_to),b=!0);"undefined"!==typeof a.filter_order_type&&($("#filter-order-type").val(a.filter_order_type.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_country&&($("#filter-country").val(a.filter_country.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_state&&($("#filter-state").val(a.filter_state.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.filter_carrier&&
($("#filter-carrier").val(a.filter_carrier.split(",")).trigger("chosen:updated"),b=!0);"undefined"!==typeof a.exclude_quotes&&"1"===a.exclude_quotes&&($("#exclude-quotes-from-search").prop("checked",!0),b=!0);"undefined"!==typeof a.is_gift&&"1"===a.is_gift&&($("#is-a-gift").prop("checked",!0),b=!0);"undefined"!==typeof a.filter_by_order_id&&$("input[name=search]").val(a.filter_by_order_id);"undefined"!==typeof a.filter_product_key&&$("input[name=filter-product-key]").val(a.filter_product_key);"undefined"!==
typeof a.filter_by_user_name&&$("input[name=user-name]").val(a.filter_by_user_name);!0===b&&$("#extra-filters").slideToggle()}this.orders.server_api=_.extend(this.orders.server_api,{id:function(){return $("input[name=search]").val()},filter:function(){return{"product-key":$("input[name=filter-product-key]","#store-orders form.filters").val(),status:$("#filter-status","#store-orders form.filters").val(),country:$("select[name=filter-country]","#store-orders form.filters").val(),state:$("select[name=filter-state]",
"#store-orders form.filters").val(),carrier:$("select[name=filter-carrier]","#store-orders form.filters").val(),"date-from":$("input[name=filter-from-date]","#store-orders form.filters").val(),"date-to":$("input[name=filter-to-date]","#store-orders form.filters").val(),"amount-from":$("input[name=filter-from-amount]","#store-orders form.filters").val(),"amount-to":$("input[name=filter-to-amount]","#store-orders form.filters").val(),user:$("input[name=user-name]","#store-orders form.filters").val(),
"filter-order-type":$("select[name=filter-order-type]","#store-orders form.filters").val(),"filter-recurring-order-type":$("select[name=filter-recurring-order-type]","#store-orders form.filters").val(),"filter-by-coupon":$("input[name=filter-by-coupon-code]","#store-orders form.filters").val(),"filter-exclude-quotes":function(){return $("#exclude-quotes-from-search").is(":checked")?"1":"0"},is_gift:function(){return $("#is-a-gift").is(":checked")?"1":"0"}}}});this.orders.on("reset",this.renderOrders,
this);this.orders.pager()},massAction:function(a){var b=$(a.currentTarget).val()+"Action";if(_.isFunction(this[b])){var c=this.orders;c.length&&this[b].call(this,c)}$(a.currentTarget).val(0)},refundShippingLabel:function(a){a.preventDefault();var f=$(a.currentTarget).data("order-id");this.orders.get(f);var c=this;$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getRefundShipmentScreenInfo/",type:"POST",dataType:"json",data:{orderId:f,secureToken:$(".orders-secure-token").val()}}).done(function(a){console.log(a);
if("1"==a.error)showMessage(a.responseText,!0,5E3);else{var e=_.isUndefined(b.Refund)?"Refund":b.Refund,h={};h[e]=function(){$(".ui-button").css("zIndex","101")};e=_.template(A,{orderId:f,i18n:b,accounting:q,moneyFormat:c.orders.moneyFormat,shippingTaxRate:c.orders.shippingTaxRate,defaultTaxes:c.orders.defaultTaxes,order:c.orders.get(f),shipmentRefundButtonStatus:a.responseText.shipment_refund_button_status,shipmentRefundScreenDescription:a.responseText.shipment_refund_screen_description});$(e).dialog({dialogClass:"seotoaster",
width:"50%",resizable:!1,buttons:h,open:function(b,f){!1===a.responseText.shipment_refund_button_status&&$(".ui-dialog-buttonset").remove()},close:function(a,b){$(this).dialog("destroy")}})}})},generateShippingLabel:function(a){_.isUndefined(b["Do you want to specify shipment date?"]);var f=_.isUndefined(b["Do you want to create a label?"])?"Do you want to create a label?":b["Do you want to create a label?"],c=_.isUndefined(b["Do you want to use this date for the shipping label?"])?"Do you want to use this date for the shipping label?":
b["Do you want to use this date for the shipping label?"],d=$(a.currentTarget).data("order-id"),e=this,h=this.orders.get(d),k={},g=_.isUndefined(b["Create label"])?"Create label":b["Create label"],n=$(a.currentTarget).closest("tr");k[g]=function(){$(".ui-dialog").css("zIndex","101");var a=$("#shipment-availability-result-"+d).data("availability-date"),f=$("#shipment-availability-result-"+d).data("availability-time");if(!$("#shipment-availability-result-"+d).data("availability-date"))return showMessage(_.isUndefined(b["Please specify shipment date"])?
"Please specify shipment date":b["Please specify shipment date"],!0,5E3),!1;if(!$("#shipment-availability-result-"+d).data("availability-time"))return showMessage(_.isUndefined(b["Please specify shipment time"])?"Please specify shipment time":b["Please specify shipment time"],!0,5E3),!1;smoke.confirm(c,function(b){b&&e.generateShippingLabelRequest(d,a,f,n)},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};smoke.confirm(f,function(a){if(a){a=JSON.parse(h.get("shipping_availability_days"));
if(_.isEmpty(a)||_.isNull(a))return showMessage(_.isUndefined(b["Shipping service does not support shipment label creation"])?"Shipping service does not support shipment label creation":b["Shipping service does not support shipment label creation"],!0,5E3),!1;var f=_.template(z,{orderId:d,i18n:b,shippingAvailabilityDays:a,accounting:q,moneyFormat:e.orders.moneyFormat,shippingTaxRate:e.orders.shippingTaxRate,defaultTaxes:e.orders.defaultTaxes,order:e.orders.get(d)}),c=[],g=[];_.each(a.availabilityDates,
function(a,b){"undefined"===typeof c[l(b,"YYYY-MM-DD").format("M")]?c[l(b,"YYYY-MM-DD").format("M")]=[parseInt(l(b,"YYYY-MM-DD").format("D"))]:c[l(b,"YYYY-MM-DD").format("M")].push(parseInt(l(b,"YYYY-MM-DD").format("D")));"undefined"===typeof g[b]?g[b]=[a]:g[b].push(a)});$(f).dialog({dialogClass:"seotoaster",width:"75%",height:"400",resizable:!1,buttons:k,open:function(a,b){$("#availability-days-datepicker").datepicker({beforeShowDay:function(a){return"undefined"===typeof c[a.getMonth()+1]?[!1,""]:
_.contains(c[a.getMonth()+1],parseInt(a.getDate()))?[!0,""]:[!1,""]},onSelect:function(){"undefined"!==typeof g[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))]&&($("#availability-shipment-time-"+d).empty(),$("#shipment-availability-summary-"+d).find(".shipment-availability-date-summary").empty().text($.datepicker.formatDate("dd M yy",$(this).datepicker("getDate"))),$("#shipment-availability-summary-"+d).find(".shipment-availability-time-summary").empty().text(""),$("#shipment-availability-result-"+
d).data("availability-date",$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))).data("availability-time",""),_.each(g[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))],function(a,b){_.each(a,function(a){$("#availability-shipment-time-"+d).append('<button class="availability-shipment-time btn">'+a+"</button>")})}))}});$("#availability-shipment-time-"+d).on("click",".availability-shipment-time",function(a){a=$(a.currentTarget);a.closest("div").find(".availability-shipment-time").removeClass("current");
a.addClass("current");$("#shipment-availability-summary-"+d).find(".shipment-availability-time-summary").empty().text(a.text());$("#shipment-availability-result-"+d).data("availability-time",a.text())})},close:function(a,b){$(this).dialog("destroy")}});checkboxRadioStyle();return!1}})},generateShippingLabelRequest:function(a,f,c,d,e){var h=this,k=h.orders.get(a);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/shippingLabel/",type:"POST",dataType:"json",data:{orderId:a,secureToken:$(".orders-secure-token").val(),
availabilityDate:f,availabilityTime:c,regenerate:e}}).done(function(e){"1"==e.error?"undefined"!==typeof e.responseText.regenerate?smoke.confirm(e.responseText.message,function(b){b&&h.generateShippingLabelRequest(a,f,c,d,!0)},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No}):showMessage(e.responseText,!0,5E3):(showMessage(e.responseText.message,!1,5E3),e.responseText.shipping_label_link&&(d.find(".shipping-label-link").removeClass("hidden").val(e.responseText.shipping_label_link),
k.set({shipping_label_link:e.responseText.shipping_label_link})),$(".ui-dialog-titlebar-close").trigger("click"))})},checkAllOrders:function(a){var b=this.orders.ordersChecked,c=[];a.target.checked?this.orders.each(function(a){b=_.union(b,[a.id]);a.set({checked:!0})}):(this.orders.each(function(a){c=_.union(c,[a.id]);a.set({checked:!1})}),b=_.difference(b,c));this.orders.ordersChecked=b;"function"===typeof _checkboxRadio&&_checkboxRadio()},toggleOrder:function(a){var b=$(a.target).val();a.target.checked?
this.orders.ordersChecked=_.union(this.orders.ordersChecked,[b]):(a=_.filter(this.orders.ordersChecked,function(a){return a!==b}),this.orders.ordersChecked=a);"function"===typeof _checkboxRadio&&_checkboxRadio()},exportOrdersAction:function(){var a=this.orders.ordersChecked.join(","),f=this.orders.server_api.filter();_.isUndefined(b.Export);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getOrderExportConfig/",type:"GET",dataType:"json"}).done(function(c){c=_.template(w,{ordersIds:a,filters:$.param(f),
i18n:b,defaultConfig:c.responseText.defaultConfig,exportConfig:c.responseText.export_config});$(c).dialog({dialogClass:"seotoaster",width:"75%",height:"750",resizable:!1});return!1})},resetFilters:function(){this.$("form.filters > :input").val("")},render:function(){},renderOrder:function(a){a.set({useInvoice:$("#invoiceEnable").val()});a.set({i18n:b});a=new u({model:a});this.$("#orders-list").append(a.render().el)},renderOrders:function(){this.$("#orders-list").empty();this.orders.each(this.renderOrder.bind(this));
this.orders.info().i18n=b;this.$("td.paginator").html(this.templates.paginator(this.orders.information))},applyFilter:function(a){"undefined"!==typeof a&&a.preventDefault();this.orders.ordersChecked=[];this.orders.currentPage=0;this.orders.pager()},resetFilter:function(a){a.preventDefault();$(a.currentTarget).closest("form").find("input:text").val("").end().find("select.filter").val("0").trigger("chosen:updated");$("#exclude-quotes-from-search").prop("checked",!1);$("#is-a-gift").prop("checked",!1);
this.applyFilter()},navigate:function(a){a.preventDefault();a=$(a.currentTarget).data("page");if($.isNumeric(a))this.orders.goTo(a);else switch(a){case "first":this.orders.goTo(this.orders.firstPage);break;case "last":this.orders.goTo(this.orders.totalPages);break;case "prev":this.orders.requestPreviousPage();break;case "next":this.orders.requestNextPage()}},sort:function(a){a=$(a.currentTarget);var b=a.data("sortkey");a.siblings(".sortable").removeClass("sortUp").removeClass("sortDown");b&&(a.hasClass("sortUp")||
a.hasClass("sortDown")?(a.hasClass("sortUp")&&(b+=" DESC"),a.hasClass("sortDown")&&(b+=" ASC"),a.toggleClass("sortUp").toggleClass("sortDown")):(a.addClass("sortUp"),b+=" ASC"),this.orders.server_api.order=b,this.orders.pager())},changeStatus:function(a){var f=this,c=$(a.currentTarget),d=parseInt(c.closest("div").data("order-id")),e=_.isUndefined(b["Are you sure you want to change status for this order?"])?"Are you sure you want to change status for this order?":b["Are you sure you want to change status for this order?"],
h=c.data("status"),k=c.data("sub-status"),g=this.orders.get(d);a=this.orders.realRefundByDefault;if("refunded"===h){var e=_.isUndefined(b["Are you sure you want to refund this payment?"])?"Are you sure you want to refund this payment?":b["Are you sure you want to refund this payment?"],n=_.isUndefined(b.Refund)?"Refund":b.Refund,p={};a=_.template(y,{i18n:b,orderId:d,gateway:g.get("gateway"),total:g.get("total"),realRefundByDefault:a});p[n]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(e,
function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/refundPayment/orderId/",type:"POST",dataType:"json",data:{orderId:$("#refund-order-id").val(),refundAmount:$(".partial-refund-amount").val(),refundInfo:$(".refund-info").val(),secureToken:$(".orders-secure-token").val(),paymentGateway:g.get("gateway"),refundUsingPaymentGateway:$("input.use-refund-payment-gateway").is(":checked")?1:0,refundTax:$(".refund-tax").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,
5E3):(showMessage(a.responseText.message,!1,5E3),g.set("status",h),g.set("total",a.responseText.total),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};$(a).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:p,resizable:!1,open:function(a,b){},close:function(a,b){$(this).dialog("destroy")}})}else if("partial"===h){if("completed"===k)return e=_.isUndefined(b["Are you sure you want to mark order as paid?"])?
"Are you sure you want to mark order as paid?":b["Are you sure you want to mark order as paid?"],smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/changeOrderStatus/",type:"POST",dataType:"json",data:{orderId:d,secureToken:$(".orders-secure-token").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText,!1,5E3),g.set("status",k),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,
cancel:_.isUndefined(b.No)?"No":b.No}),"";e=_.isUndefined(b["Are you sure you want to send payment request?"])?"Are you sure you want to send payment request?":b["Are you sure you want to send payment request?"];n=_.isUndefined(b["Send payment request"])?"Send payment request":b["Send payment request"];p={};a=_.template(B,{i18n:b,orderId:d,total:g.get("total")});p[n]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/sendPaymentInfoEmail/",
type:"POST",dataType:"json",data:{orderId:$("#send-notification-order-id").val(),secureToken:$(".orders-secure-token").val(),sendPaymentRequestMessage:m.activeEditor.getContent()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText,!1,5E3),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};$(a).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:p,resizable:!1,open:function(a,
b){m.remove();f.initTiny(f.orders.sendPaymentInfoDefaultText)},close:function(a,b){m.remove();$(this).dialog("destroy")}})}else smoke.confirm(e,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order?id="+d,data:{status:h},type:"POST",dataType:"json",beforeSend:function(){c.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){showMessage(_.isUndefined(b.Saved)?"Saved":
b.Saved,a.hasOwnProperty("error")&&a.error);!a.error&&a.hasOwnProperty("responseText")&&g.set("status",a.responseText.status)}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})},changeTracking:function(a){var f=$(a.currentTarget),c=parseInt(f.closest("tr").find("td.order-id").text()),d=this.orders.get(c);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/fetchShippingUrlNames/orderId/"+c,type:"GET",dataType:"json"}).done(function(a){a=_.template(x,{data:a.responseText.data,
defaultSelection:a.responseText.defaultSelection,shippingTrackingCodeId:a.responseText.shippingTrackingCodeId,trackingName:a.responseText.trackingName,orderId:c,i18n:b});$(a).dialog({width:600,dialogClass:"seotoaster",resizable:!1,open:function(a,e){$(".save-data").on("click",function(a){a.preventDefault();a=$("#marketing-services").val();var e=$("#shippingTrackingId").val();a={trackingUrlId:a,shippingTrackingId:e,id:c};$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order",data:a,type:"POST",
dataType:"json",beforeSend:function(){f.closest("td").find(".tracking-info").hide();f.closest("td").find(".ajax-loader").show()},success:function(a){a.hasOwnProperty("error")&&!a.error&&showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved);if(a.hasOwnProperty("responseText")){var c=f.closest("td").find(".tracking-code-text").text();d.set({status:a.responseText.status,shipping_tracking_id:a.responseText.shippingTrackingId})}c==a.responseText.shippingTrackingId&&(f.closest("td").find(".ajax-loader").hide(),
f.closest("td").find(".tracking-info").show());$("#tracking-dialog").dialog("close")}})})},close:function(a,b){$(this).dialog("close").remove()}})})},sendInvoice:function(a){a=$(a.currentTarget);var f=parseInt(a.closest("tr").find("td.order-id").text()),c=a.closest("td"),d=c.html();$.ajax({url:$("#website_url").val()+"plugin/invoicetopdf/run/sendInvoiceToUser/",data:{cartId:f,dwn:0},type:"POST",dataType:"json",beforeSend:function(){c.html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},
success:function(a){a.hasOwnProperty("error")&&(a.error?showMessage(a.responseText,!1,5E3):showMessage(_.isUndefined(b["Invoice has been sent"])?"Invoice has been sent":b["Invoice has been sent"]));c.html(d)}})},toggleRecurring:function(a){"recurring_id"===$(a.currentTarget).val()?$(".recurring-filters").removeClass("hidden"):$(".recurring-filters").addClass("hidden")},getParams:function(){var a={},b=[];location.search.substr(1).split("&").forEach(function(c){b=c.split("=");a[decodeURIComponent(b[0])]=
decodeURIComponent(b[1])});return a},initTiny:function(a){var b=$("#website_url").val(),c=this;m.init({script_url:b+"system/js/external/tinymce/tinymce.gzip.php",selector:"#send-payment-notification-info",skin:"seotoaster",menubar:!1,browser_spellcheck:!0,resize:!1,convert_urls:!1,relative_urls:!1,statusbar:!1,allow_script_urls:!0,force_p_newlines:!0,forced_root_block:!1,entity_encoding:"raw",plugins:["advlist lists link anchor image charmap visualblocks code media table paste textcolor fullscreen autolink"],
toolbar1:"leadshortcode bold italic underline alignleft aligncenter alignright alignjustify | bullist numlist forecolor backcolor | link unlink image media hr | formatselect | fontsizeselect | pastetext code | fullscreen | spellcheckbtn",fontsize_formats:"8px 10px 12px 14px 16px 18px 24px 36px",block_formats:"Block=div;Paragraph=p;Block Quote=blockquote;Cite=cite;Address=address;Code=code;Preformatted=pre;H2=h2;H3=h3;H4=h4;H5=h5;H6=h6",image_advtab:!0,extended_valid_elements:"a[*],input[*],select[*],textarea[*]",
setup:function(b){b.on("change blur keyup",function(a,b){c.dispatchEditorKeyup(a,b,null);this.save()});b.on("init",function(c){b.setContent(a)})}});this.tinimce=m},dispatchEditorKeyup:function(a,b,c){var d=c;null===d&&(d=setTimeout(function(){d=null},1E3))}})});
