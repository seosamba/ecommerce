define(["backbone","../collections/orders","./order","text!../templates/paginator.html","text!../templates/export_dialog.html","text!../templates/tracking_code.html","text!../templates/refund_dialog.html","text!../templates/shipping_labels_dates_dialog.html","text!../templates/refund_shipment_dialog.html","text!../templates/send_payment_request_dialog.html","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln","moment","accounting","tinyMCE"],function(q,r,t,u,v,w,x,y,z,A,b,m,p,n){return q.View.extend({el:$("#store-orders"),
events:{"click #extra-filters-switch":function(){$("#extra-filters",this.el).slideToggle()},"change input.filter":"applyFilter","change #orders-check-all":"checkAllOrders","click #orders-filter-apply-btn":"applyFilter","click td.paginator a.page":"navigate","click th.sortable":"sort","click button.change-status":"changeStatus","click td.shipping-service .setTracking":"changeTracking","click .sendInvoice":"sendInvoice","click #orders-filter-reset-btn":"resetFilter",'change select[name="order-mass-action"]':"massAction",
'change input[name="check-order[]"]':"toggleOrder","change #filter-order-type":"toggleRecurring","click .generate-shipping-order-label":"generateShippingLabel","click .refund-shipping-order-label":"refundShippingLabel"},templates:{paginator:_.template(u)},initialize:function(){this.orders=new r;this.orders.ordersChecked=[];var a=this.getParams();if(!_.isEmpty(a)&&"undefined"!==typeof a.filter){console.log(a);var c=!1;"undefined"!==typeof a.filter_from_date&&($("#orders-filter-fromdate").val(a.filter_from_date),
c=!0);"undefined"!==typeof a.filter_to_date&&($("#orders-filter-todate").val(a.filter_to_date),c=!0);"undefined"!==typeof a.filter_status&&($("#filter-status").val(a.filter_status.split(",")).trigger("chosen:updated"),c=!0);"undefined"!==typeof a.filter_by_coupon_code&&($("#filter-by-coupon-code").val(a.filter_by_coupon_code),c=!0);"undefined"!==typeof a.filter_from_amount&&($("input[name=filter-from-amount]","#store-orders form.filters").val(a.filter_from_amount),c=!0);"undefined"!==typeof a.filter_from_amount&&
($("input[name=filter-to-amount]","#store-orders form.filters").val(a.filter_from_to),c=!0);"undefined"!==typeof a.filter_order_type&&($("#filter-order-type").val(a.filter_order_type.split(",")).trigger("chosen:updated"),c=!0);"undefined"!==typeof a.filter_country&&($("#filter-country").val(a.filter_country.split(",")).trigger("chosen:updated"),c=!0);"undefined"!==typeof a.filter_state&&($("#filter-state").val(a.filter_state.split(",")).trigger("chosen:updated"),c=!0);"undefined"!==typeof a.filter_carrier&&
($("#filter-carrier").val(a.filter_carrier.split(",")).trigger("chosen:updated"),c=!0);"undefined"!==typeof a.exclude_quotes&&"1"===a.exclude_quotes&&($("#exclude-quotes-from-search").prop("checked",!0),c=!0);"undefined"!==typeof a.is_gift&&"1"===a.is_gift&&($("#is-a-gift").prop("checked",!0),c=!0);"undefined"!==typeof a.filter_by_order_id&&$("input[name=search]").val(a.filter_by_order_id);"undefined"!==typeof a.filter_product_key&&$("input[name=filter-product-key]").val(a.filter_product_key);"undefined"!==
typeof a.filter_by_user_name&&$("input[name=user-name]").val(a.filter_by_user_name);!0===c&&$("#extra-filters").slideToggle()}this.orders.server_api=_.extend(this.orders.server_api,{id:function(){return $("input[name=search]").val()},filter:function(){return{"product-key":$("input[name=filter-product-key]","#store-orders form.filters").val(),status:$("#filter-status","#store-orders form.filters").val(),country:$("select[name=filter-country]","#store-orders form.filters").val(),state:$("select[name=filter-state]",
"#store-orders form.filters").val(),carrier:$("select[name=filter-carrier]","#store-orders form.filters").val(),"date-from":$("input[name=filter-from-date]","#store-orders form.filters").val(),"date-to":$("input[name=filter-to-date]","#store-orders form.filters").val(),"amount-from":$("input[name=filter-from-amount]","#store-orders form.filters").val(),"amount-to":$("input[name=filter-to-amount]","#store-orders form.filters").val(),user:$("input[name=user-name]","#store-orders form.filters").val(),
"filter-order-type":$("select[name=filter-order-type]","#store-orders form.filters").val(),"filter-recurring-order-type":$("select[name=filter-recurring-order-type]","#store-orders form.filters").val(),"filter-by-coupon":$("input[name=filter-by-coupon-code]","#store-orders form.filters").val(),"filter-exclude-quotes":function(){return $("#exclude-quotes-from-search").is(":checked")?"1":"0"},is_gift:function(){return $("#is-a-gift").is(":checked")?"1":"0"}}}});this.orders.on("reset",this.renderOrders,
this);this.orders.pager()},massAction:function(a){var c=$(a.currentTarget).val()+"Action";if(_.isFunction(this[c])){var b=this.orders;b.length&&this[c].call(this,b)}$(a.currentTarget).val(0)},refundShippingLabel:function(a){a.preventDefault();var c=$(a.currentTarget).data("order-id");this.orders.get(c);var d=this;$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getRefundShipmentScreenInfo/",type:"POST",dataType:"json",data:{orderId:c,secureToken:$(".orders-secure-token").val()}}).done(function(a){console.log(a);
if("1"==a.error)showMessage(a.responseText,!0,5E3);else{var f=_.isUndefined(b.Refund)?"Refund":b.Refund,g={};g[f]=function(){$(".ui-button").css("zIndex","101")};f=_.template(z,{orderId:c,i18n:b,accounting:p,moneyFormat:d.orders.moneyFormat,shippingTaxRate:d.orders.shippingTaxRate,defaultTaxes:d.orders.defaultTaxes,order:d.orders.get(c),shipmentRefundButtonStatus:a.responseText.shipment_refund_button_status,shipmentRefundScreenDescription:a.responseText.shipment_refund_screen_description});$(f).dialog({dialogClass:"seotoaster",
width:"50%",resizable:!1,buttons:g,open:function(b,c){!1===a.responseText.shipment_refund_button_status&&$(".ui-dialog-buttonset").remove()},close:function(a,b){$(this).dialog("destroy")}})}})},generateShippingLabel:function(a){_.isUndefined(b["Do you want to specify shipment date?"]);var c=_.isUndefined(b["Do you want to create a label?"])?"Do you want to create a label?":b["Do you want to create a label?"],d=_.isUndefined(b["Do you want to use this date for the shipping label?"])?"Do you want to use this date for the shipping label?":
b["Do you want to use this date for the shipping label?"],e=$(a.currentTarget).data("order-id"),f=this,g=this.orders.get(e),h={},k=_.isUndefined(b["Create label"])?"Create label":b["Create label"],l=$(a.currentTarget).closest("tr");h[k]=function(){$(".ui-dialog").css("zIndex","101");var a=$("#shipment-availability-result-"+e).data("availability-date"),c=$("#shipment-availability-result-"+e).data("availability-time");if(!$("#shipment-availability-result-"+e).data("availability-date"))return showMessage(_.isUndefined(b["Please specify shipment date"])?
"Please specify shipment date":b["Please specify shipment date"],!0,5E3),!1;if(!$("#shipment-availability-result-"+e).data("availability-time"))return showMessage(_.isUndefined(b["Please specify shipment time"])?"Please specify shipment time":b["Please specify shipment time"],!0,5E3),!1;smoke.confirm(d,function(b){b&&f.generateShippingLabelRequest(e,a,c,l)},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};smoke.confirm(c,function(a){if(a){a=JSON.parse(g.get("shipping_availability_days"));
if(_.isEmpty(a)||_.isNull(a))return showMessage(_.isUndefined(b["Shipping service does not support shipment label creation"])?"Shipping service does not support shipment label creation":b["Shipping service does not support shipment label creation"],!0,5E3),!1;var c=_.template(y,{orderId:e,i18n:b,shippingAvailabilityDays:a,accounting:p,moneyFormat:f.orders.moneyFormat,shippingTaxRate:f.orders.shippingTaxRate,defaultTaxes:f.orders.defaultTaxes,order:f.orders.get(e)}),d=[],k=[];_.each(a.availabilityDates,
function(a,b){"undefined"===typeof d[m(b,"YYYY-MM-DD").format("M")]?d[m(b,"YYYY-MM-DD").format("M")]=[parseInt(m(b,"YYYY-MM-DD").format("D"))]:d[m(b,"YYYY-MM-DD").format("M")].push(parseInt(m(b,"YYYY-MM-DD").format("D")));"undefined"===typeof k[b]?k[b]=[a]:k[b].push(a)});$(c).dialog({dialogClass:"seotoaster",width:"75%",height:"400",resizable:!1,buttons:h,open:function(a,b){$("#availability-days-datepicker").datepicker({beforeShowDay:function(a){return"undefined"===typeof d[a.getMonth()+1]?[!1,""]:
_.contains(d[a.getMonth()+1],parseInt(a.getDate()))?[!0,""]:[!1,""]},onSelect:function(){"undefined"!==typeof k[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))]&&($("#availability-shipment-time-"+e).empty(),$("#shipment-availability-summary-"+e).find(".shipment-availability-date-summary").empty().text($.datepicker.formatDate("dd M yy",$(this).datepicker("getDate"))),$("#shipment-availability-summary-"+e).find(".shipment-availability-time-summary").empty().text(""),$("#shipment-availability-result-"+
e).data("availability-date",$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))).data("availability-time",""),_.each(k[$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate"))],function(a,b){_.each(a,function(a){$("#availability-shipment-time-"+e).append('<button class="availability-shipment-time btn">'+a+"</button>")})}))}});$("#availability-shipment-time-"+e).on("click",".availability-shipment-time",function(a){a=$(a.currentTarget);a.closest("div").find(".availability-shipment-time").removeClass("current");
a.addClass("current");$("#shipment-availability-summary-"+e).find(".shipment-availability-time-summary").empty().text(a.text());$("#shipment-availability-result-"+e).data("availability-time",a.text())})},close:function(a,b){$(this).dialog("destroy")}});checkboxRadioStyle();return!1}})},generateShippingLabelRequest:function(a,c,d,e,f){var g=this,h=g.orders.get(a);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/shippingLabel/",type:"POST",dataType:"json",data:{orderId:a,secureToken:$(".orders-secure-token").val(),
availabilityDate:c,availabilityTime:d,regenerate:f}}).done(function(f){"1"==f.error?"undefined"!==typeof f.responseText.regenerate?smoke.confirm(f.responseText.message,function(b){b&&g.generateShippingLabelRequest(a,c,d,e,!0)},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No}):showMessage(f.responseText,!0,5E3):(showMessage(f.responseText.message,!1,5E3),f.responseText.shipping_label_link&&(e.find(".shipping-label-link").removeClass("hidden").val(f.responseText.shipping_label_link),
h.set({shipping_label_link:f.responseText.shipping_label_link})),$(".ui-dialog-titlebar-close").trigger("click"))})},checkAllOrders:function(a){var b=this.orders.ordersChecked,d=[];a.target.checked?this.orders.each(function(a){b=_.union(b,[a.id]);a.set({checked:!0})}):(this.orders.each(function(a){d=_.union(d,[a.id]);a.set({checked:!1})}),b=_.difference(b,d));this.orders.ordersChecked=b;"function"===typeof _checkboxRadio&&_checkboxRadio()},toggleOrder:function(a){var b=$(a.target).val();a.target.checked?
this.orders.ordersChecked=_.union(this.orders.ordersChecked,[b]):(a=_.filter(this.orders.ordersChecked,function(a){return a!==b}),this.orders.ordersChecked=a);"function"===typeof _checkboxRadio&&_checkboxRadio()},exportOrdersAction:function(){var a=this.orders.ordersChecked.join(","),c=this.orders.server_api.filter();_.isUndefined(b.Export);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/getOrderExportConfig/",type:"GET",dataType:"json"}).done(function(d){d=_.template(v,{ordersIds:a,filters:$.param(c),
i18n:b,defaultConfig:d.responseText.defaultConfig,exportConfig:d.responseText.export_config});$(d).dialog({dialogClass:"seotoaster",width:"75%",height:"750",resizable:!1});return!1})},resetFilters:function(){this.$("form.filters > :input").val("")},render:function(){},renderOrder:function(a){a.set({useInvoice:$("#invoiceEnable").val()});a.set({i18n:b});a=new t({model:a});this.$("#orders-list").append(a.render().el)},renderOrders:function(){this.$("#orders-list").empty();this.orders.each(this.renderOrder.bind(this));
this.orders.info().i18n=b;this.$("td.paginator").html(this.templates.paginator(this.orders.information))},applyFilter:function(a){"undefined"!==typeof a&&a.preventDefault();this.orders.ordersChecked=[];this.orders.currentPage=0;this.orders.pager()},resetFilter:function(a){a.preventDefault();$(a.currentTarget).closest("form").find("input:text").val("").end().find("select.filter").val("0").trigger("chosen:updated");$("#exclude-quotes-from-search").prop("checked",!1);$("#is-a-gift").prop("checked",!1);
this.applyFilter()},navigate:function(a){a.preventDefault();a=$(a.currentTarget).data("page");if($.isNumeric(a))this.orders.goTo(a);else switch(a){case "first":this.orders.goTo(this.orders.firstPage);break;case "last":this.orders.goTo(this.orders.totalPages);break;case "prev":this.orders.requestPreviousPage();break;case "next":this.orders.requestNextPage()}},sort:function(a){a=$(a.currentTarget);var b=a.data("sortkey");a.siblings(".sortable").removeClass("sortUp").removeClass("sortDown");b&&(a.hasClass("sortUp")||
a.hasClass("sortDown")?(a.hasClass("sortUp")&&(b+=" DESC"),a.hasClass("sortDown")&&(b+=" ASC"),a.toggleClass("sortUp").toggleClass("sortDown")):(a.addClass("sortUp"),b+=" ASC"),this.orders.server_api.order=b,this.orders.pager())},changeStatus:function(a){var c=this,d=$(a.currentTarget),e=parseInt(d.closest("div").data("order-id")),f=_.isUndefined(b["Are you sure you want to change status for this order?"])?"Are you sure you want to change status for this order?":b["Are you sure you want to change status for this order?"],
g=d.data("status"),h=this.orders.get(e);a=this.orders.realRefundByDefault;if("refunded"===g){var f=_.isUndefined(b["Are you sure you want to refund this payment?"])?"Are you sure you want to refund this payment?":b["Are you sure you want to refund this payment?"],k=_.isUndefined(b.Refund)?"Refund":b.Refund,l={};a=_.template(x,{i18n:b,orderId:e,gateway:h.get("gateway"),total:h.get("total"),realRefundByDefault:a});l[k]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(f,function(a){a&&$.ajax({url:$("#website_url").val()+
"plugin/shopping/run/refundPayment/orderId/",type:"POST",dataType:"json",data:{orderId:$("#refund-order-id").val(),refundAmount:$(".partial-refund-amount").val(),refundInfo:$(".refund-info").val(),secureToken:$(".orders-secure-token").val(),paymentGateway:h.get("gateway"),refundUsingPaymentGateway:$("input.use-refund-payment-gateway").is(":checked")?1:0,refundTax:$(".refund-tax").val()},success:function(a){1===a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText.message,!1,5E3),
h.set("status",g),h.set("total",a.responseText.total),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})};$(a).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:l,resizable:!1,open:function(a,b){},close:function(a,b){$(this).dialog("destroy")}})}else"partial"===g?(f=_.isUndefined(b["Are you sure you want to send payment request?"])?"Are you sure you want to send payment request?":b["Are you sure you want to send payment request?"],
k=_.isUndefined(b["Send payment request"])?"Send payment request":b["Send payment request"],l={},a=_.template(A,{i18n:b,orderId:e,total:h.get("total")}),l[k]=function(){$(".ui-dialog").css("zIndex","101");smoke.confirm(f,function(a){a&&$.ajax({url:$("#website_url").val()+"plugin/shopping/run/sendPaymentInfoEmail/",type:"POST",dataType:"json",data:{orderId:$("#send-notification-order-id").val(),secureToken:$(".orders-secure-token").val(),sendPaymentRequestMessage:n.activeEditor.getContent()},success:function(a){1===
a.error?showMessage(a.responseText,!0,5E3):(showMessage(a.responseText,!1,5E3),$(".ui-dialog-titlebar-close").trigger("click"))}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":b.No})},$(a).dialog({dialogClass:"seotoaster",width:"35%",height:"450",buttons:l,resizable:!1,open:function(a,b){n.remove();c.initTiny(c.orders.sendPaymentInfoDefaultText)},close:function(a,b){n.remove();$(this).dialog("destroy")}})):smoke.confirm(f,function(a){a&&$.ajax({url:$("#website_url").val()+
"plugin/shopping/run/order?id="+e,data:{status:g},type:"POST",dataType:"json",beforeSend:function(){d.closest("td").html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){showMessage(_.isUndefined(b.Saved)?"Saved":b.Saved,a.hasOwnProperty("error")&&a.error);!a.error&&a.hasOwnProperty("responseText")&&h.set("status",a.responseText.status)}})},{ok:_.isUndefined(b.Yes)?"Yes":b.Yes,cancel:_.isUndefined(b.No)?"No":
b.No})},changeTracking:function(a){var c=$(a.currentTarget),d=parseInt(c.closest("tr").find("td.order-id").text()),e=this.orders.get(d);$.ajax({url:$("#website_url").val()+"plugin/shopping/run/fetchShippingUrlNames/orderId/"+d,type:"GET",dataType:"json"}).done(function(a){a=_.template(w,{data:a.responseText.data,defaultSelection:a.responseText.defaultSelection,shippingTrackingCodeId:a.responseText.shippingTrackingCodeId,trackingName:a.responseText.trackingName,orderId:d,i18n:b});$(a).dialog({width:600,
dialogClass:"seotoaster",resizable:!1,open:function(a,f){$(".save-data").on("click",function(a){a.preventDefault();a=$("#marketing-services").val();var f=$("#shippingTrackingId").val();a={trackingUrlId:a,shippingTrackingId:f,id:d};$.ajax({url:$("#website_url").val()+"plugin/shopping/run/order",data:a,type:"POST",dataType:"json",beforeSend:function(){c.closest("td").find(".tracking-info").hide();c.closest("td").find(".ajax-loader").show()},success:function(a){a.hasOwnProperty("error")&&!a.error&&showMessage(_.isUndefined(b.Saved)?
"Saved":b.Saved);if(a.hasOwnProperty("responseText")){var d=c.closest("td").find(".tracking-code-text").text();e.set({status:a.responseText.status,shipping_tracking_id:a.responseText.shippingTrackingId})}d==a.responseText.shippingTrackingId&&(c.closest("td").find(".ajax-loader").hide(),c.closest("td").find(".tracking-info").show());$("#tracking-dialog").dialog("close")}})})},close:function(a,b){$(this).dialog("close").remove()}})})},sendInvoice:function(a){a=$(a.currentTarget);var c=parseInt(a.closest("tr").find("td.order-id").text()),
d=a.closest("td"),e=d.html();$.ajax({url:$("#website_url").val()+"plugin/invoicetopdf/run/sendInvoiceToUser/",data:{cartId:c,dwn:0},type:"POST",dataType:"json",beforeSend:function(){d.html('<img src="'+$("#website_url").val()+'system/images/ajax-loader-small.gif" style="margin: 20px auto; display: block;">')},success:function(a){a.hasOwnProperty("error")&&(a.error?showMessage(a.responseText,!1,5E3):showMessage(_.isUndefined(b["Invoice has been sent"])?"Invoice has been sent":b["Invoice has been sent"]));
d.html(e)}})},toggleRecurring:function(a){"recurring_id"===$(a.currentTarget).val()?$(".recurring-filters").removeClass("hidden"):$(".recurring-filters").addClass("hidden")},getParams:function(){var a={},b=[];location.search.substr(1).split("&").forEach(function(d){b=d.split("=");a[decodeURIComponent(b[0])]=decodeURIComponent(b[1])});return a},initTiny:function(a){var b=$("#website_url").val(),d=this;n.init({script_url:b+"system/js/external/tinymce/tinymce.gzip.php",selector:"#send-payment-notification-info",
skin:"seotoaster",menubar:!1,browser_spellcheck:!0,resize:!1,convert_urls:!1,relative_urls:!1,statusbar:!1,allow_script_urls:!0,force_p_newlines:!0,forced_root_block:!1,entity_encoding:"raw",plugins:["advlist lists link anchor image charmap visualblocks code media table paste textcolor fullscreen autolink"],toolbar1:"leadshortcode bold italic underline alignleft aligncenter alignright alignjustify | bullist numlist forecolor backcolor | link unlink image media hr | formatselect | fontsizeselect | pastetext code | fullscreen | spellcheckbtn",
fontsize_formats:"8px 10px 12px 14px 16px 18px 24px 36px",block_formats:"Block=div;Paragraph=p;Block Quote=blockquote;Cite=cite;Address=address;Code=code;Preformatted=pre;H2=h2;H3=h3;H4=h4;H5=h5;H6=h6",image_advtab:!0,extended_valid_elements:"a[*],input[*],select[*],textarea[*]",setup:function(b){b.on("change blur keyup",function(a,b){d.dispatchEditorKeyup(a,b,null);this.save()});b.on("init",function(c){b.setContent(a)})}});this.tinimce=n},dispatchEditorKeyup:function(a,b,d){var e=d;null===e&&(e=
setTimeout(function(){e=null},1E3))}})});
