define(["backbone","../models/product","../models/option","../collections/products_pager","../collections/tags_lazy","../collections/options","../collections/images","./tag","./option","./productlist","../../coupons/views/coupon_form","../../coupons/views/coupons_table","../../groups/views/group_price","i18n!../../../nls/"+$("input[name=system-language]").val()+"_ln"],function(e,f,g,l,m,n,p,h,q,k,r,s,t,c){return e.View.extend({el:$("#manage-product"),events:{"click #new-product":"newProduct","click .show-list":"toggleList",
"keyup input#new-tag":"newTag","click #add-new-option-btn":"newOption","change #option-library":"addOption","click #submit":"saveProduct","click #product-image-folder":"imageChange","click .box":"setProductImage","change :input[data-reflection]":"setProperty","change #product-enabled":"toggleEnabled","change #free-shipping":"toggleFreeShipping","change #product-tags-available .tag-widget input[name^=tag]":"toggleTag","click #delete":"deleteProduct","keypress input#new-brand":"newBrand","keypress #product-list-search":"filterProducts",
'click a[href="#options-tab"]':"fetchOptionLibrary","submit form.binded-plugin":"formSubmit","change #product-list-holder input.marker":"markProducts","click #massaction":"massAction","click #product-list-back-link":"hideProductList","click a[data-role=editProduct]":"productAction","click #toggle-current-tags":function(a){a.preventDefault();checkboxRadioStyle();$("#product-tags-current, #product-tags-available, .paginator","#tag-tab").toggle()},"click .paginator a.page":"paginatorAction","change #automated-set-price":"toggleSetPriceConfig"},
products:null,tags:null,brands:null,searchIndex:null,websiteUrl:$("#website_url").val(),mediaPath:$("#media-path").val(),initialize:function(){var a=this;this.initProduct();$(document).ajaxStart(function(){$("#product-list-search").attr("disabled","disabled")}).ajaxStop(function(){$("#product-list-search").removeAttr("disabled")});this.quickPreviewTmpl=_.template($("#quickPreviewTemplate").html());$("#product-list").hide("slide",{direction:"right"});hideSpinner();this.$el.tabs({beforeLoad:function(b,
d){d.ajaxSettings.url+="?"+$.param({productId:a.model.get("id")})}});this.$el.on("tabsbeforeactivate",function(b,d){switch(d.newPanel.selector){case "#tag-tab":a.initTags();break;case "#coupon-tab":case "#group-pricing-tab":if(a.model.isNew())return showMessage(_.isUndefined(c["Please save product information first"])?"Please save product information first":c["Please save product information first"],!0),!1}}).show();this.images=new p;this.images.on("reset",this.renderImages,this);this.render();this.couponForm=
new r;this.couponGrid=new s({hideProductColumn:!0});this.couponForm.$el.on("coupon:created",_.bind(this.couponGrid.render,this.couponGrid));this.couponForm.render();this.groupsPrice=new t},initProducts:function(){null===this.products&&(this.products=new l,this.products.bind("add",this.renderProduct,this),this.products.bind("reset",this.renderProducts,this));return this.products},initTags:function(){null===this.tags&&(showSpinner("#tag-tab"),this.tags=new m,this.tags.template=_.template($("#tagTemplate").html()),
this.tags.on("add",this.renderTag,this),this.tags.on("reset",this.renderTags,this),this.tags.pager())},initProduct:function(){this.model=new f;this.model.on("change:tags",this.renderProductTags,this);this.model.on("change:related",this.renderRelated,this);this.model.on("change:id",this.setProductIdForCouponAndGroup,this);this.model.on("sync",function(){this.model.has("options")&&(this.model.get("options").on("add",this.renderOption,this),this.model.get("options").on("reset",this.renderOptions,this));
null!==this.products&&this.products.pager();this.render();var a=_.isUndefined(c["Product saved."])?"Product saved.":c["Product saved."],b=_.isUndefined(c["Go to your search engine optimized product landing page here."])?"Go to your search engine optimized product landing page here.":c["Go to your search engine optimized product landing page here."];showMessage(a+"</br>"+b)},this);this.model.on("error",this.processSaveError,this);this.model.get("options").on("add",this.renderOption,this);this.model.get("options").on("reset",
this.renderOptions,this);return this},newProduct:function(a){a.preventDefault();this.initProduct().render();window.history&&window.history.pushState&&window.history.pushState({},document.title,window.location.href.replace(/id.*$/,""))},toggleEnabled:function(a){this.model.set({enabled:this.$("#product-enabled").prop("checked")?1:0})},toggleFreeShipping:function(a){this.model.set({freeShipping:this.$("#free-shipping").prop("checked")?1:0})},newTag:function(a){var b=$.trim(a.currentTarget.value),d=
new RegExp(/[^\u0080-\uFFFF\w\s-]+/gi);if(13==a.keyCode&&""!==b){if(d.test(b))return showMessage(_.isUndefined(c["Tag name should contain only letters, digits and spaces"])?"Tag name should contain only letters, digits and spaces":c["Tag name should contain only letters, digits and spaces"],!0),$(a.currentTarget).blur(),!1;this.tags.create({name:b},{wait:!0,success:function(a,b){$("#new-tag").val("").blur()},error:function(a,b){showMessage(b.responseText,!0)}});this.tags.nameTag=""}else this.tags.nameTag=
b;this.tags.currentPage=1;this.tags.fetch()},newOption:function(){var a=new g;a.get("selection").add({isDefault:1});this.model.get("options").add(a);this.renderOptions()},addOption:function(){var a=this.$("#option-library").val();if(0<a){var a=this.optionLibrary.get(a),b=new g({title:a.get("title"),parentId:a.get("id"),type:a.get("type")});b.get("selection").reset(a.get("selection").map(function(a){a.unset("id");return a.toJSON()}));this.model.get("options").add(b);this.model.trigger("change")}$("#option-library").val("-1")},
imageChange:function(a){$("#image-select-dialog").show("slide",{direction:"left"});a=$(a.target).val();if("0"!=a){var b=this;this.images.server_api.folder=a;this.images.flush().fetch({success:function(){b.images.pager();hideSpinner()},silent:!0})}},renderImages:function(){$("#image-list").html(_.template($("#imgTemplate").html(),{images:this.images.toJSON()}));$(".paginator","#image-select-dialog").replaceWith(_.template($("#paginatorTemplate").html(),_.extend(this.images.paginator_ui,this.images.info(),
{collection:"images",cssClass:""})))},setProductImage:function(a){a=$(a.currentTarget).find("img").data("name");var b=this.$("#product-image-folder").val();this.model.set({photo:b+"/"+a});this.$("#product-image").attr("src",$("#website_url").val()+this.mediaPath+b+"/small/"+a);this.$("#image-select-dialog").hide("slide",{direction:"left"});this.$("#product-image-folder").val("0");this.$("#image-list, .paginator").empty()},setProperty:function(a){var b=$(a.currentTarget).data("reflection");this.model.set(b,
_.isNaN(a.currentTarget.value)?null:a.currentTarget.value)},render:function(){console.log("render: app.js",this.model.changedAttributes());this.$el.tabs({active:0});$("#product-list:visible").hide("slide",{direction:"right"});$("#quick-preview").empty();this.model.isNew()?$("#delete").hide():$("#delete").show();var a=$("#website_url").val()+"system/images/noimage.png";this.model.has("photo")?(a=this.model.get("photo"),/^https?:\/\/.*/.test(a)||(a=$("#website_url").val()+this.mediaPath+a.replace("/",
"/small/"))):this.$("#product-image").attr("src",$("#website_url").val()+"system/images/noimage.png");this.$("#product-image").attr("src",a);this.$("#product-brand").val(-1);var b=this;_.each(this.model.toJSON(),function(a,c){b.$("[data-reflection="+c+"]").val(a)});this.model.has("related")&&_.isEmpty(this.model.get("related"))&&this.$("#related-holder").find(".spinner").remove();this.renderOptions();parseInt(this.model.get("enabled"))?this.$("#product-enabled").attr("checked","checked"):this.$("#product-enabled").removeAttr("checked");
parseInt(this.model.get("freeShipping"))?this.$("#free-shipping").attr("checked","checked"):this.$("#free-shipping").removeAttr("checked");this.model.has("pageTemplate")?this.$("#product-pageTemplate").val(this.model.get("pageTemplate")):this.model.has("page")?this.$("#product-pageTemplate").val(this.model.get("page").templateId):this.$("#product-pageTemplate").val("-1");this.model.isNew()||$("#quick-preview").html(this.quickPreviewTmpl({product:this.model.toJSON(),websiteUrl:$("#website_url").val(),
currency:this.$("#currency-unit").text(),photoUrl:a}));hideSpinner()},renderTag:function(a,b){var d=new h({model:a});d.render();b instanceof e.Collection?$("#product-tags-available").prepend(d.$el):$("#product-tags-available").append(d.$el);$(".tagid-"+a.get("id"),"#product-tags-current").size()&&d.$el.addClass("tag-current").find("input:checkbox").prop({disabled:!0,checked:!0})},renderTags:function(){showSpinner("#tag-tab");$("#product-tags-available").empty();this.tags.each(this.renderTag,this);
$(".paginator","#tag-tab").replaceWith(_.template($("#paginatorTemplate").html(),_.extend({pages:2,collection:"tags",cssClass:"fl-right ml-grid mt5px"},this.tags.info())));hideSpinner()},toggleTag:function(a){if(a.currentTarget.checked){var b={id:a.currentTarget.value,name:$(a.currentTarget).closest(".tag-widget").find(".tag-editable").text()},d=this.model.get("tags")||[];this.model.set("tags",_.union(d,b))}$(a.currentTarget).attr({disabled:"disabled"}).closest(".tag-widget").effect("transfer",{to:"#toggle-current-tags",
className:"ui-effects-transfer"},500)},renderProductTags:function(){console.log("render product tags");$(".tag-widget input:checkbox","#product-tags-available").prop({disabled:!1,checked:!1}).closest(".tag-widget").removeClass("tag-current");if(this.model&&this.model.has("tags")){var a=this,b=$("#product-tags-current").empty();_.each(this.model.get("tags"),function(d){var c=new h({model:new e.Model(d)});c.delegateEvents({"change input:checkbox[name^=tag]":function(){var b=this.model.get("id"),d=_.reject(a.model.get("tags"),
function(a){return a.id===b});a.model.set("tags",d);$(".tagid-"+b+" input:checkbox","#product-tags-available").prop({disabled:!1,checked:!1}).closest(".tag-widget").removeClass("tag-current")}});$(".tagid-"+d.id+" input:checkbox","#product-tags-available").prop({disabled:!0,checked:!0}).closest(".tag-widget").addClass("tag-current");c.render().$el.find(".ticon-remove").remove().end().find("input:checkbox").prop("checked",!0).end().appendTo(b)})}else $("#product-tags-current").html('<p class="nothing">'+
$("#product-list-holder").data("emptymsg")+"</p>")},renderBrands:function(a){var b=_.template("<% _.each(brands, function(brand){ %><option value='<%= brand %>'><%= brand %></option><% }); %>");$("#product-brand").html('<option value="-1" disabled>Select a brand</option>'+b({brands:_.sortBy(a,function(a){return a.toLowerCase()})}));this.model&&this.model.has("brand")?this.$("#product-brand").val(this.model.get("brand")):this.$("#product-brand").val(-1)},renderProduct:function(a){var b=new k({model:a});
this.$("#product-list-holder").append(b.render().el);_.has(this.products,"checked")&&_.contains(this.products.checked,a.get("id"))&&b.$el.find("input.marker").prop({checked:!0})},renderProducts:function(){if(this.products.size()){this.$("#product-list-holder").empty();this.products.each(this.renderProduct,this);var a={collection:"products",cssClass:""},a=_.extend(a,this.products.info());$(".paginator","#product-list").replaceWith(_.template($("#paginatorTemplate").html(),a))}else $("#product-list-holder").html('<p class="nothing">'+
$("#product-list-holder").data("emptymsg")+"</p>")},saveProduct:function(){showSpinner();if(!this.validateProduct())return hideSpinner(),showMessage(_.isUndefined(c["Missing some required fields"])?"Missing some required fields":c["Missing some required fields"],!0),$("#manage-product").tabs({active:0}),!1;if(this.model.has("options")){var a=!_.isEmpty(_.compact(this.model.get("options").pluck("isTemplate")));this.model.set({defaultOptions:this.model.get("options").toJSON()})}var b=$("#new-brand").val();
b&&this.addNewBrand(b).$("#new-brand").val("");this.model.save();a&&this.hasOwnProperty("optionLibrary")&&this.optionLibrary.fetch()},processSaveError:function(a,b){hideSpinner();showMessage(b.responseText,!0)},deleteProduct:function(){var a=this;if(this.model.isNew())return showMessage(_.isUndefined(c["Product is not saved yet"])?"Product is not saved yet":c["Product is not saved yet"],!0),!1;showConfirm("Dragons ahead! Are you sure?",function(){a.model.destroy({success:function(b,d){a.products&&
a.products.pager();$("#new-product").trigger("click");showMessage(_.isUndefined(c["Product deleted"])?"Product deleted":c["Product deleted"]);location.reload()}})})},validateProduct:function(){var a=!1;if(this.$("#product-pageTemplate").val()){var b=this.$("#product-pageTemplate").val();this.model.set({pageTemplate:b});this.$("#product-pageTemplate").removeClass("error")}else this.$("#product-pageTemplate").addClass("error"),$(".missing-template").addClass("error"),a=!0;this.model.has("name")&&""!==
$.trim(this.model.get("name"))?this.$("#product-name").removeClass("error"):(this.$("#product-name").addClass("error"),a=!0);this.model.has("sku")&&""!==$.trim(this.model.get("sku"))?this.$("#product-sku").removeClass("error"):(this.$("#product-sku").addClass("error"),a=!0);this.model.has("price")?this.$("#product-price").removeClass("error"):(this.$("#product-price").addClass("error"),a=!0);this.model.has("brand")||""!==$.trim($("#new-brand").val())?this.$("#product-brand").removeClass("error"):
(this.$("#product-brand").addClass("error"),a=!0);this.model.has("photo")?this.$(".product-preview").removeClass("error"):(this.$(".product-preview").addClass("error"),a=!0);this.model.has("shortDescription")&&""!==$.trim(this.model.get("shortDescription"))?this.$("#product-shortDescription").removeClass("error"):(this.$("#product-shortDescription").addClass("error"),a=!0);return!a},productAction:function(a){a=$(a.currentTarget).data("pid");switch($("#product-list-holder").data("type")){case "edit":this.model.clear({silent:!0}).set(this.products.get(a).toJSON());
this.model.get("options").on("add",this.renderOption,this);this.render();window.history&&window.history.pushState&&window.history.pushState({},document.title,window.location.href.replace(/product.*$/,"product/id/"+a));break;case "related":this.addRelated(a);break;case "set":this.addPart(a)}$("#product-list").hide("slide",{direction:"right"});return!1},addRelated:function(a){if(_.isNull(a)||_.isUndefined(a))return!1;var b=_.map(this.model.get("related"),function(a){return parseInt(a)}),b=_.union(b,
a);this.model.set({related:_.without(b,this.model.get("id"))})},toggleSetPriceConfig:function(a){a=$(a.currentTarget).prop("checked")?1:0;$.post($("#website_url").val()+"plugin/shopping/run/setConfig/",{config:{autocalculateSetPrice:a}})},removeRelated:function(a){var b=_(this.model.get("related")).map(function(a){return parseInt(a)});this.model.set({related:_.without(b,parseInt(a))})},renderRelated:function(){$("#related-holder").find(".productlisting:not(.show-list)").remove();showSpinner();if(this.model.has("related")&&
this.model.get("related").length){var a=this.model.get("related"),b=this;$.ajax({url:this.model.urlRoot(),data:{id:a.join(",")},success:function(a){if(!a)return!1;a&&!_.isArray(a)&&(a=[a]);$("#related-holder").find(".productlisting:not(.show-list)").remove();showSpinner();_.each(a,function(a){a=new k({model:new f(a),showDelete:!0});a.delegateEvents({"click .delete":function(){b.removeRelated(this.model.get("id"))}});a.render().$el.css({cursor:"default"}).appendTo("#related-holder")});hideSpinner()}})}else hideSpinner();
return!1},newBrand:function(a){var b=$.trim(this.$("#new-brand").val());13===a.keyCode&&""!==b&&(this.addNewBrand(b).$("#new-brand").val(""),this.$("#product-brand").focus());return this},addNewBrand:function(a){a=$.trim(a);var b=_.map($("#product-brand option"),function(a){return a.value});_.include(_.map(b,function(a){return a.toLowerCase()}),a.toLowerCase())?a=_.find(b,function(b){return b.toLowerCase()==a.toLowerCase()}):b.push(a);this.model.set({brand:a});this.renderBrands(b);return this},filterProducts:function(a,
b){if(13===a.keyCode||!0===b)$("#product-list-holder").html('<div class="spinner"></div>'),this.products.key=a.currentTarget.value,this.products.goTo(this.products.firstPage),$(a.target).autocomplete("close")},renderOption:function(a){(new q({model:a})).render().$el.appendTo("#options-holder");checkboxRadioStyle()},renderOptions:function(){$("#options-holder").empty();if(!this.model.has("options"))return!1;this.model.get("options").each(this.renderOption,this)},fetchOptionLibrary:function(){_.has(this,
"optionLibrary")||(this.optionLibrary=new n,this.optionLibrary.on("reset",function(a){$("#option-library").html(_.template($("#optionLibraryTemplate").html(),{items:a.toJSON()}))},this),this.optionLibrary.fetch())},formSubmit:function(a){a=$(a.target);$.ajax({url:a.attr("action"),type:a.attr("method"),data:a.serialize(),dataType:"json",success:function(a){a.hasOwnProperty("result")&&smoke.alert(a.result)}});return!1},markProducts:function(a){var b=_.has(this.products,"checked")?this.products.checked:
[],c=parseInt(a.currentTarget.value),b=a.currentTarget.checked?_.union(b,c):_.without(b,c);this.products.checked=b;console.log(b)},massAction:function(){var a=$("#product-list-holder").data("type");if(!_.has(this.products,"checked")||_.isEmpty(this.products.checked))return!1;switch(a){case "edit":this.massDelete(this.products.checked);break;case "related":this.addRelated(this.products.checked);$("#product-list").hide("slide",{direction:"right"});break;case "set":this.addPart(this.products.checked),
$("#product-list").hide("slide",{direction:"right"})}$("div.productlisting input.marker:checked","#product-list-holder").prop({checked:!1});this.products.checked=[];return!1},massDelete:function(a){var b=this;showConfirm("Oh man... Really?",function(){_.isEmpty(a)||$.ajax({url:b.products.paginator_core.url()+"id/"+a.join(","),type:"DELETE",dataType:"json",statusCode:{403:function(){showMessage(_.isUndefined(c["Forbidden action"])?"Forbidden action":c["Forbidden action"],!0)},409:function(){showMessage(_.isUndefined(c["Can't remove products"])?
"Can't remove products":c["Can't remove products"],!0)}}}).done(function(){b.products.remove(a);showMessage(_.isUndefined(c["Products removed"])?"Products removed":c["Products removed"])})})},initSearchIndex:_.once(function(){var a=this;$.getJSON($("#website_url").val()+"plugin/shopping/run/searchindex",function(b){a.searchIndex=b;$("#product-list-search").autocomplete({minLength:2,source:a.searchIndex,select:function(a,b){$("#product-list-search").val(b.item.value).trigger("keypress",!0)}})})}),
toggleList:function(a){a.preventDefault();this.initSearchIndex();a=$(a.currentTarget).data("listtype");$("#product-list").show("slide",{direction:"right"});$("#product-list-holder").data("type",a);$("#massaction").html({related:"<span class='success'>[ Add as related ]</span>",edit:"<span class='error'>[ Delete selected ]</span>",set:"[ add to set ]"}[a]);if(null===this.products)return $("#product-list-holder").html('<div class="spinner"></div>'),this.initProducts().pager()},hideProductList:function(){$("#product-list").hide("slide",
{direction:"right"});var a=$.trim($("#product-list-search").val());a!=this.products.key&&(""==a?$("#product-list-search").trigger("keypress",!0):$("#product-list-search").val(this.products.key))},paginatorAction:function(a){var b=$(a.currentTarget).data("page");a=$(a.currentTarget).parent(".paginator").data("collection");if(!a)return!1;_.has(this,a)&&(a=this[a]);switch(b){case "first":a.goTo(a.firstPage);break;case "prev":a instanceof e.Paginator.requestPager?a.requestPreviousPage():a.previousPage();
break;case "next":a instanceof e.Paginator.requestPager?a.requestNextPage():a.nextPage();break;case "last":a.goTo(a.totalPages);break;default:b=parseInt(b),!_.isNaN(b)&&a.goTo(b)}return!1},setProductIdForCouponAndGroup:function(){var a=this.model.get("id"),b=this.model.get("price");this.couponForm.$el.find("input#data-products").val(a);this.couponGrid.coupons.server_api.productId=a;this.couponGrid.render();this.groupsPrice.$el.find("input#group-products-price").val(b);this.groupsPrice.$el.find("input#group-products-id").val(a);
this.$el.find("#group-regular-price").html(" "+$("#group-products-price-symbol").val()+parseFloat(b).toFixed(2));this.groupsPrice.groups.server_api.productId=a;this.groupsPrice.render()}})});
