if(_.isUndefined(TFilter)){var TFilter={},AttributesCollection=Backbone.Collection.extend({url:function(){return $("#website_url").val()+"api/filtering/filters/"}});TFilter.Attributes=new AttributesCollection;TFilter.MainView=Backbone.View.extend({tags:[],events:{"change .filtering-attribute-widget input":"saveAttributeValue","keyup [name=new-attribute]":"attachAttribute"},initialize:function(){this.productId=this.$el.data("productid");this.$tabs=this.$el.find("div.plugin-filtering-builder-content");
this.$tabs.tabs();this.$tabs.on("tabsactivate",_.bind(this.initTagsBlock,this));this.data=this.$el.data();var a=this;this.$el.find("input.typeahead").autocomplete({source:_.bind(this.autocomplete,this),select:function(b,c){a.renderAttribute(c.item,"getAttribute").find("input:text").focus();$(this).val("").blur();return!1}})},setTags:function(a){_.isEmpty(a)||(this.tags=a);return this},getTags:function(){return this.tags},attachAttribute:function(a){a.preventDefault();if(13===a.keyCode){var b=this,
c=$(a.currentTarget),d=c.val(),f=[];a=TFilter.Attributes.find(function(a){return a.get("label")===d});_.each(this.$el.find(".apply-to-tags input:checkbox:checked"),function(a){f.push($(a).val())});if(a){c.val("");var e=this.$el.find('.product-filters-list input[name="'+a.get("name")+'"]');e.length?e.focus():b.renderAttribute(_.extend({tags:f},a.toJSON())).find("input:text").focus()}else TFilter.Attributes.create({label:d},{success:function(a,d){c.val("").blur();var e={attribute_id:a.get("id"),label:a.get("label"),
name:a.get("name"),tags:f};b.renderAttribute(e).find("input:text").focus()},error:function(a,b){showMessage(b.responseText,!0)}})}},initTagsBlock:function(){var a="";_.isEmpty(this.tags)?a="<label>This product has no tags yet</label>":_.each(this.tags,function(b){a+='<label><input type="checkbox" name="tags[]" value="'+b.id+'" />'+_.escape(b.name)+"</label>"});this.$el.find(".apply-to-tags").html(a)},loadAttributes:function(a){_.isEmpty(a)||_.each(a,this.renderAttribute,this)},renderAttribute:function(a,
b){var c=this.$el.find('input[name="'+a.name+'"]'),d=[];if(c.length)return c.closest("p.filtering-attribute-widget");_.isUndefined(this.list)&&(this.list=this.$el.find(".product-filters-list"));_.has(a,"tags")&&(d=a.tags);c=a.value;"getAttribute"==b&&(c="");return $("<p>",{"class":"filtering-attribute-widget"}).append($("<label>").html(a.label)).append($("<input>",{type:"text",name:a.name,value:_.unescape(c)}).data({aid:a.attribute_id,tags:d})).appendTo(this.list)},saveAttributeValue:function(a){var b=
$(a.currentTarget);a=b.val();if(0<=a.indexOf("'")||0<=a.indexOf('"'))a=a.replace(/["]/g,"\u201d"),a=a.replace(/[']/g,"\u2019");a={product_id:this.productId,attribute_id:b.data("aid"),tags:b.data("tags"),value:a};$.ajax({url:$("#website_url").val()+"api/filtering/eav/",type:"PUT",data:JSON.stringify(a),success:function(a){b.val(_.unescape(a.value))}})},autocomplete:function(a,b){var c=$.ui.autocomplete.escapeRegex(a.term).toLowerCase(),d=_.chain(TFilter.Attributes.toJSON()).filter(function(a){return-1!==
a.label.toLowerCase().search(c)}).map(function(a){return{attribute_id:a.id,name:a.name,label:a.label,value:null}}).value();b(d)}});$(function(){TFilter.Attributes.fetch()})};
